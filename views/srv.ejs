<% layout('layout') %>
<style>
  @media (max-width: 900px) {
    body {
      overflow-y: auto;
      margin-bottom: 100px;
    }
    .sidef {
      display: none !important;
    }
    .mainf {
      width: 100%;
      display: block;
      height: auto;
      margin-bottom: 100px !important;
    }
    #mainPanel {
      display: none;
    }
    #headPanel {
      height: auto !important;
      width: 100%;
      flex-direction: column;
      .tnav {
        width: 100%;
      }
    }
    #qBtn {
      display: none;
    }
    .ttl {
      display: none;
    }
    .reqPlts {
      display: block !important;
    }
    .jik {
      display: flex !important;
    }
  }
  .reqPlts {
    display: none;
  }
  a:hover {
    transform: scale(1.02);
  }
  .searchBar {
    width: fit-content !important;
    max-width: 30%;
  }
  .borderGreen {
    border: 1px solid rgb(2, 192, 2);
  }
  .rqCard .selectBar:hover {
    background-color: transparent !important;
  }
  .unseen2 {
    right: -100%;
    overflow: hidden;
    transition: right 0.6s ease-in-out;
    z-index: 100;
  }
  .seen2 {
    right: 0;
    transition: right 0.4s ease-in-out;
    z-index: 100;
  }
</style>

<% let loopRequests = (['Admin', 'Head', 'Dev'].includes(user.role)) ? requests : userRequests; %>

<div class="bgWhite shadow2 fixed top0 width25 index100 col justifyStart padding20 unseen2" id="qPanel">
  <section class="justifyBetween">
    <a href="javascript:void(0)" class="nav cnav porcelain" id="qClose"><i class="fas fa-angles-right"></i></a>
  </section>
  <br>
  <form action="/quick-assign" method="POST" class="porcelain padding20">
    <section class="justifyBetween padding0">
      <p class="size22">Quick Assign</p>
    </section>
    <section class="col alignStart padding0">
        <p class="size14 green str400"><%= loopRequests.filter(r => !r.processBy).length %> requests found</p>
    </section>
    <% const unassignedRequests = loopRequests.filter(r => !r.processBy); %>
    <% if (unassignedRequests.length > users.length ) { %>
    <br>
    <section class="justifyBetween padding0 col alignStart gap5">
      <p class="size12">Select the team members to assign these requests:</p>
      <p class="kelt bgRed100"><i class="fas fa-info-circle"></i> Please select at least one team member!</p>
    </section>
    <br>
    <% users.filter(user => user.campus === 'Main').forEach(user => { %>
      <div class="height0 gap5 marginBottom10 justifyStart">
        <input type="checkbox" name="assignedUsers" value="<%= user._id.toString() %>">
        <p class="flex"><%= user.fName %> <%= user.lName %> 
          <span class="marginLeft10 green str600 countAss"></span>
        </p>
      </div>
    <% }) %>
    <br>
    <section class="bgWhite corner10">This action can't be undone</section>
    <br>
    <div class="field alignEnd">
      <button type="submit" class="nav pnav width100"><i class="fas fa-check"></i> Assign To All</button>
    </div>
    <% } else { %>
      <br>
      <p class="textBalance">The number of unassigned requests is currently less than the number of available staff.</p>
    <% } %>
  </form>
  <div class="absolute top0 left0 bgWhite padding40" id="warnCard">
    <section class="col porcelain gap10">
      <%- include('icons/bell') %>
      <p class="size14 textCenter textBalance">Are you sure you want to assign the selected staff to these requests? This action can't be undone!</p>
      <section class="gap5 col padding0">
        <a href="javascript:void(0)" class="nav width100 corner10 pnav" id="Proceed">Submit</a>
        <a href="javascript:void(0)" class="width100 colorPrimary" id="closeWarn">No, Go Back</a>
      </section>
    </section>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const qForm = document.querySelector('#qPanel form');
  const warnCard = document.getElementById('warnCard');
  const proceedBtn = document.getElementById('Proceed');
  const closeWarn = document.getElementById('closeWarn');
  const assignBtn = qForm.querySelector('button[type="submit"]');
  const checkboxes = qForm.querySelectorAll('input[name="assignedUsers"]');
  const keltDiv = document.querySelector('.kelt'); // the hidden warning div

  // Hide warnCard and keltDiv by default
  warnCard.style.display = 'none';
  if (keltDiv) keltDiv.classList.add('hidden');

  // When "Assign To All" button is clicked
  assignBtn.addEventListener('click', (e) => {
    e.preventDefault(); // stop form from submitting immediately

    // Check if at least one checkbox is checked
    const isAnyChecked = Array.from(checkboxes).some(cb => cb.checked);

    if (!isAnyChecked) {
      // Show hidden warning div
      if (keltDiv) keltDiv.classList.remove('hidden');
      return; // stop execution if none checked
    }

    // Hide keltDiv if at least one checked
    if (keltDiv) keltDiv.classList.add('hidden');

    // Show confirmation overlay
    warnCard.style.display = 'flex';
  });

  // Automatically hide keltDiv when any checkbox is clicked
  checkboxes.forEach(cb => {
    cb.addEventListener('change', () => {
      const isAnyChecked = Array.from(checkboxes).some(c => c.checked);
      if (isAnyChecked && keltDiv) {
        keltDiv.classList.add('hidden');
      }
    });
  });

  // When "Cancel" is clicked
  closeWarn.addEventListener('click', () => {
    warnCard.style.display = 'none'; // hide confirmation overlay
  });

  // When "Submit" on warnCard is clicked
  proceedBtn.addEventListener('click', () => {
    warnCard.style.display = 'none'; // hide confirmation
    qForm.submit(); // submit the form
  });
});
</script>



<script>
  document.addEventListener('DOMContentLoaded', () => {
  const totalRequests = <%= loopRequests.filter(r => !r.processBy).length %>;
  const checkboxes = document.querySelectorAll('input[name="assignedUsers"]');

  function updateCounts() {
    const checked = Array.from(checkboxes).filter(cb => cb.checked);
    const numChecked = checked.length;

    if (numChecked === 0) {
      checkboxes.forEach(cb => {
        const span = cb.closest('div').querySelector('.countAss');
        span.textContent = '';
      });
      return;
    }

    const base = Math.floor(totalRequests / numChecked);
    let remainder = totalRequests % numChecked;

    checked.forEach(cb => {
      const span = cb.closest('div').querySelector('.countAss');
      let count = base;
      if (remainder > 0) {
        count += 1;
        remainder -= 1;
      }
      span.textContent = count;
    });

    // Clear unchecked spans
    checkboxes.forEach(cb => {
      if (!cb.checked) {
        const span = cb.closest('div').querySelector('.countAss');
        span.textContent = '';
      }
    });
  }

  checkboxes.forEach(cb => cb.addEventListener('change', updateCounts));
});

</script>


<script>
document.addEventListener("DOMContentLoaded", () => {
  const qBtn = document.getElementById("qBtn");
  const qClose = document.getElementById("qClose");
  const qPanel = document.getElementById("qPanel");

  if (!qBtn || !qClose || !qPanel) return;

  qBtn.addEventListener("click", () => {
    qPanel.classList.remove("unseen2");
    qPanel.classList.add("seen2");
  });

  qClose.addEventListener("click", () => {
    qPanel.classList.remove("seen2");
    qPanel.classList.add("unseen2");
  });
});
</script>

<%- include('partials/header') %>
<section class="reqPlts col">
  <section class="col" id="">
    <% if (loopRequests.length === 0) { %>
      <div class="h500 borderGray borderDotted corner16">
      </div>
    <% } else { %>
      <section class="width0 col hidden" id="NoRecords">
        <%- include('icons/notFound') %>
        <p class="size18 str400">Sorry, No Record Found!</p>
      </section>
      <% loopRequests.forEach((rq, i) => { %>
        <% if (!rq.declineAt) { %>
        <div class="height0 padding8 rqCard col">

          <% if ( title === 'Transactions') { %>
            <a href="/srvView/<%= rq._id %>" class="width100 col bgWhite shadow1 padding20 gap0 corner12 alignStart relative rqPlt">
          <% } else if ( title === 'For Release') { %>
            <a href="/relView/<%= rq._id %>" class="width100 col bgWhite shadow1 padding20 gap0 corner12 alignStart relative rqPlt">
          <% } else if ( title === 'Processing') { %>
            <a href="/prcView/<%= rq._id %>" class="width100 col bgWhite shadow1 padding20 gap0 corner12 alignStart relative rqPlt">
          <% } else if ( title === 'Approved') { %>
            <a href="/aprView/<%= rq._id %>" class="width100 col bgWhite shadow1 padding20 gap0 corner12 alignStart relative rqPlt">
          <% } else if ( title === 'To Verify') { %>
            <a href="/vrfView/<%= rq._id %>" class="width100 col bgWhite shadow1 padding20 gap0 corner12 alignStart relative rqPlt">
          <% } else { %>
            <a href="/srvView/<%= rq._id %>" class="width100 col bgWhite shadow1 padding20 gap0 corner12 alignStart relative rqPlt">
          <% } %>
            <p class="absolute top20 right20"><%= rq.createdAtFormatted %></p>

            <div class="width100 justifyStart"><img src="<%= rq.requestBy?.photo || '/images/profile.png' %>" alt="Profile" class="h40 w40 wMin40 borderPrimary corner500"></div>
            <br>
            <div class="width100 col alignStart">
              <p class="size16 str500"><%= rq.requestBy ? rq.requestBy.fName : '' %> <%= rq.requestBy ? rq.requestBy.mName : '' %> <%= rq.requestBy ? rq.requestBy.lName : '' %> <%= rq.requestBy ? rq.requestBy.xName : '' %></p>
              <p class="str400"><span class="green"><%= rq.requestBy ? rq.requestBy.role : '' %> &bull; </span> <%= rq.requestBy?.schoolId || '--' %></p>
              <p class="str400"><span class=""><%= rq.requestBy ? rq.requestBy.campus : '' %> &bull; </span> <%= rq.requestBy?.course || '--' %></p>
              <% if ( title === "To Verify") { %>
                <p class="str400 marginBottom5 blue">
                  <i class="bi bi-building"></i> <%= rq.requestBy?.campus || '--' %>
                  &nbsp; | &nbsp;
                  <i class="fas fa-address-card"></i> <%= rq.requestBy?.schoolId || 'No Student Number' %>
                </p>
              <% } else { %>
                <p class="str400 marginBottom5 blue textWrap" style="width: 85%;" title="<%= rq.items?.map(item => item.type || '').join(', ') || '' %>">
                  <i class="fas fa-receipt"></i> <%= rq.tr ? rq.tr : '' %> &bull; <i class="fas fa-file-lines"></i> 
                  <%= rq.items?.map(item => item.type || '').join(', ') || '' %>
                </p>
              <% } %>
            </div>
            
            <br>
            <% if ( rq.holdAt) { %>
              <p class="str400 bgRed100"> On Hold</p>
            <% } else if ( rq.declineAt) { %>
              <p class="str400 bgRed100"> Declined</p>
            <% } else { %>
              <p class="str400
                <% if ( rq.status === "Pending" ) { %>
                    bgBlue100
                <% } else if ( rq.status === "Reviewed" ) { %>
                    bgViolet100
                <% } else if ( rq.status === "Assessed" ) { %>
                    bgYellow100
                <% } else if ( rq.status === "Verified" ) { %>
                    bgGreen100
                <% } else if ( rq.status === "For Release" ) { %>
                    bgGreen100
                <% } else if ( rq.status === "Claimed" ) { %>
                    bgGray100
                <% } else { %>
                    bgBlue100
                <% } %>
                  border0"> <%= rq.status === "Assessed" ? "For Payment" : rq.status === "Reviewed" ? "For Assessment" : rq.status || "" %>
                </p>
            <% } %>
          </a>
        </div>
        <% } %>
      <% }) %>
    <% } %>
  </section>
</section>
<section class="col" id="mainPanel">
  <% if (loopRequests.length === 0) { %>
    <div class="h500 borderGray borderDotted corner16">
    </div>
  <% } else { %>
    <section class="width0 col hidden" id="NoRecords">
      <%- include('icons/notFound') %>
      <p class="size18 str400">Sorry, No Record Found!</p>
    </section>
    <% loopRequests.forEach((rq, i) => { %>
      <% if (!rq.declineAt) { %>
      <div class="height0 padding8 rqCard">
         <% if (['Admin', 'Head', 'Dev'].includes(user.role)) { %>
        <div class="width25 <% if (rq.processBy) { %> bgWhite shadow1 <% } else { %> bgSoft borderGray borderDotted <% } %> padding15 gap0 corner12 alignStart relative">
            <% if ( rq.status === "Pending") { %>
              <% if (rq.processBy) { %>
              <div class="width18 justifyStart"><img src="<%= rq.processBy?.photo || '/images/profile.png' %>" alt="Profile"  class="h40 w40 wMin40 borderPrimary corner500 primaryProfile"></div>
              <div class="width82 col alignStart gap5">
                <p class="str400"> Assign To </p>
                <div class="selectBar widthMin100">
                  <select name="processBy" class="processByDropdown" data-request-id="<%= rq._id %>">
                    <option value="" selected>-- Select Staff --</option>
                    <% users.forEach(user => { %>
                      <option value="<%= user._id %>" 
                        <%= rq.processBy && rq.processBy._id.toString() === user._id.toString() ? 'selected' : '' %>>
                        <%= user.fName %> <%= user.lName %> <%= user.xName %>
                      </option>
                    <% }) %>
                  </select>
                </div>
              </div>
              <% } else { %>
              <div class="width100 col alignStart gap5">
                <p class="str400"> Unassigned </p>
                <div class="selectBar widthMin100 bgSoft">
                  <select name="processBy" class="processByDropdown bgSoft" data-request-id="<%= rq._id %>">
                    <option value="" selected>-- Select Staff --</option>
                    <% users.forEach(user => { %>
                      <option value="<%= user._id %>" 
                        <%= rq.processBy && rq.processBy._id.toString() === user._id.toString() ? 'selected' : '' %>>
                        <%= user.fName %> <%= user.lName %> <%= user.xName %>
                      </option>
                    <% }) %>
                  </select>
                </div>
              </div>
              <% } %>
            <% } else { %>
                <div class="width18 justifyStart"><img src="<%= rq.processBy?.photo || '/images/profile.png' %>" alt="Profile" class="h40 w40 wMin40 borderPrimary corner500 primaryProfile"></div>
                <div class="width82 col alignStart gap5">
                  <p class="size12 str500 bgSoft corner5 padding5"><%= rq.processBy ? rq.processBy.fName : '' %> <%= rq.processBy ? rq.processBy.mName : '' %> <%= rq.processBy ? rq.processBy.lName : '' %> <%= rq.processBy ? rq.processBy.xName : '' %></p>
                  <% if (rq.status === 'For Release') { %>
                  <p class="str400 green"><i class="fas fa-check-circle"></i> Processed</p>
                  <% } else if (rq.status === 'Claimed') { %>
                  <p class="str400 green"><i class="fas fa-flag"></i> Released</p>
                  <% } else if (rq.status === 'Pending') { %>
                  <p class="str400 navy"><i class="fas fa-hourglass-half"></i> Waiting For Review ..</p>
                  <% } else { %>
                  <p class="str400 yellow"><i class="fas fa-clock"></i> Already Processing .. </p>
                  <% } %>
                  <p class="str400"> Assigned at <%= rq.assignAtFormatted %></p>
                </div>
            <% } %>
        </div>

        <div class="height0 width0 gap0 padding0"><% for(let i = 0; i < 6; i++) { %>&bull;<% } %></div>

        <% } else { %>

        <% } %>

        

        
        <% if ( title === 'Transactions') { %>
          <a href="/srvView/<%= rq._id %>" class="width65 bgWhite shadow1 padding20 gap0 corner12 alignStart relative rqPlt">
        <% } else if ( title === 'For Release') { %>
          <a href="/relView/<%= rq._id %>" class="width65 bgWhite shadow1 padding20 gap0 corner12 alignStart relative rqPlt">
        <% } else if ( title === 'Processing') { %>
          <a href="/prcView/<%= rq._id %>" class="width65 bgWhite shadow1 padding20 gap0 corner12 alignStart relative rqPlt">
        <% } else if ( title === 'Approved') { %>
          <a href="/aprView/<%= rq._id %>" class="width65 bgWhite shadow1 padding20 gap0 corner12 alignStart relative rqPlt">
        <% } else if ( title === 'To Verify') { %>
          <a href="/vrfView/<%= rq._id %>" class="width65 bgWhite shadow1 padding20 gap0 corner12 alignStart relative rqPlt">
        <% } else { %>
          <a href="/srvView/<%= rq._id %>" class="width65 bgWhite shadow1 padding20 gap0 corner12 alignStart relative rqPlt">
        <% } %>
          <p class="absolute top20 right20"><%= rq.createdAtFormatted %></p>

          <% if ( rq.holdAt) { %>
            <p class="str400 absolute bottom20 right20 bgRed100"> On Hold</p>
          <% } else if ( rq.declineAt) { %>
            <p class="str400 absolute bottom20 right20 bgRed100"> Declined</p>
          <% } else { %>
            <p class="str400 absolute bottom20 right20
              <% if ( rq.status === "Pending" ) { %>
                  bgBlue100
              <% } else if ( rq.status === "Reviewed" ) { %>
                  bgViolet100
              <% } else if ( rq.status === "Assessed" ) { %>
                  bgYellow100
              <% } else if ( rq.status === "Verified" ) { %>
                  bgGreen100
              <% } else if ( rq.status === "For Release" ) { %>
                  bgGreen100
              <% } else if ( rq.status === "Claimed" ) { %>
                  bgGray100
              <% } else { %>
                  bgBlue100
              <% } %>
                border0"> <%= rq.status === "Assessed" ? "For Payment" : rq.status === "Reviewed" ? "For Assessment" : rq.status || "" %>
              </p>
          <% } %>

          <div class="width10 justifyStart"><img src="<%= rq.requestBy?.photo || '/images/profile.png' %>" alt="Profile" class="h40 w40 wMin40 borderPrimary corner500"></div>
          <div class="width90 col alignStart">
            <p class="size16 str500"><%= rq.requestBy ? rq.requestBy.fName : '' %> <%= rq.requestBy ? rq.requestBy.mName : '' %> <%= rq.requestBy ? rq.requestBy.lName : '' %> <%= rq.requestBy ? rq.requestBy.xName : '' %></p>
            <p class="str400"><span class="green"><%= rq.requestBy ? rq.requestBy.role : '' %> &bull; </span> <%= rq.requestBy?.schoolId || '--' %></p>
            <p class="str400"><span class=""><%= rq.requestBy ? rq.requestBy.campus : '' %> &bull; </span> <%= rq.requestBy?.course || '--' %></p>
            <% if ( title === "To Verify") { %>
              <p class="str400 marginBottom5 blue">
                <i class="bi bi-building"></i> <%= rq.requestBy?.campus || '--' %>
                &nbsp; | &nbsp;
                <i class="fas fa-address-card"></i> <%= rq.requestBy?.schoolId || 'No Student Number' %>
              </p>
            <% } else { %>
              <p class="str400 marginBottom5 blue textWrap" style="width: 85%;" title="<%= rq.items?.map(item => item.type || '').join(', ') || '' %>">
                 <i class="fas fa-receipt"></i> <%= rq.tr ? rq.tr : '' %> &bull; <i class="fas fa-file-lines"></i> 
                <%= rq.items?.map(item => item.type || '').join(', ') || '' %>
              </p>
            <% } %>
          </div>
        </a>
      </div>
      <% } %>
    <% }) %>
  <% } %>
</section>
<div id="processMessageModal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background-color:rgba(0,0,0,0.5); justify-content:center; align-items:center; z-index:9999; opacity: 0;" class="hidden">
  <div style="background:#fff; padding:20px; border-radius:8px; min-width:250px; text-align:center;">
    <p id="processMessageText" style="font-weight:500;"></p>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const searchInput = document.getElementById('univ');
  const cards = document.querySelectorAll('.rqCard'); 
  const noFound = document.getElementById('NoRecords');

  searchInput.addEventListener('input', () => {
    const query = searchInput.value.trim().toLowerCase();
    let found = 0;

    cards.forEach(card => {
      // Clone the card text
      let cardText = card.textContent.toLowerCase();

      // Remove text of unselected options from the card text
      const unselectedOptions = card.querySelectorAll('.processByDropdown option:not(:checked)');
      unselectedOptions.forEach(opt => {
        const optText = opt.textContent.toLowerCase();
        cardText = cardText.replace(optText, '');
      });

      if (cardText.includes(query)) {
        card.style.display = ''; // show
        found++;
      } else {
        card.style.display = 'none'; // hide
      }
    });

    noFound.style.display = found === 0 ? 'flex' : 'none';
  });
});
</script>


<script>
const messageModal = document.getElementById('processMessageModal');
const messageText = document.getElementById('processMessageText');

document.querySelectorAll('.processByDropdown').forEach(dropdown => {
  dropdown.addEventListener('change', async (e) => {
    const requestId = e.target.dataset.requestId;
    const userId = e.target.value;

    console.log('ðŸŸ¡ Assigning staff:', userId, 'for request:', requestId);

    try {
      const res = await fetch(`/req/processBy/${requestId}`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ processBy: userId })
      });

      const data = await res.json();
      console.log('ðŸŸ¢ Server response:', data);

      if (res.ok) {
        messageText.textContent = data.message || 'Updated successfully.';
        messageText.style.color = 'green';
        messageModal.style.display = 'flex';

        setTimeout(() => {
          console.log('ðŸ” Redirecting to /srv');
          window.location.href = '/srv';
        }, 0);
      } else {
        messageText.textContent = data.error || 'Update failed.';
        messageText.style.color = 'red';
        messageModal.style.display = 'flex';
        setTimeout(() => messageModal.style.display = 'none', 3000);
      }

    } catch (err) {
      console.error('âŒ Fetch error:', err);
      messageText.textContent = 'Something went wrong.';
      messageText.style.color = 'red';
      messageModal.style.display = 'flex';
      setTimeout(() => messageModal.style.display = 'none', 3000);
    }
  });
});
</script>
