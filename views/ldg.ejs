<% layout('layout') %>
<style>
  @media (max-width: 900px) {
    body {
      overflow-y: auto;
      margin-bottom: 100px;
    }
    .sidef {
      display: none !important;
    }
    .mainf {
      width: 100%;
      display: block;
      height: auto;
      margin-bottom: 100px !important;
    }
    .searchBar {
        width: 100%;
    }
    #title {
        display: none;
    }
    #mainPanel {
      display: none;
    }
    #headPanel {
      height: auto !important;
      width: 100%;
      flex-direction: column;
      .tnav {
        width: 100%;
      }
    }
        #xtra {
            display: flex !important;
        }
    .sub {
        margin-top: 10px;
        flex-direction: column !important;
        height: auto;
        width: 100% !important;
        padding: 0;
        div {
            width: 100% !important;
        }
    }
    #trail {
        flex-direction: column !important;
        height: auto !important;
        width: 100% !important;
        div {
            justify-content: start !important;
            width: 100% !important;
        }
        p {
            text-align: left !important;
            width: 100%;
            margin-top: 10px;
        }
    }
    #trail div {
        width: 100% !important;
        min-width: 100%;
    }
    .selectBar select {
        min-width: 100% !important;
    }
    #trail #pagination {
        flex-wrap: wrap !important;
        justify-content: center !important;
        align-items: center !important;
    }
    #qBtn {
      display: none;
    }
    .ttl {
      display: none;
    }
    .reqPlts {
      display: block !important;
    }
    .jik {
      display: flex !important;
    }
  }
  .reqPlts {
    display: none;
  }
  td:last-child, th:last-child {
      display: block !important;
  }
  strong {
    font-size: inherit;
    font-weight: 600;
  }
</style>
<div class="justifyBetween height10 padding15 corner10 relative hidden" id="xtra">
    <a href="/dsb" class="nav"><i class="fas fa-chevron-left"></i> Go Back</a>
    <p class="size20">Activity Log</p>
</div>
<div class="justifyBetween height10 padding15 corner10 relative bgWhite">
    <p class="size30" id="title">Activity Log</p>
    <div class="searchBar colorPrimary width20" style="border-radius: 10px;">
        <i class="fas fa-search"></i>
        <input type="search" name="" id="univ" class="">
    </div>
</div>
<div class="height78 marginTop10 block overflow-y1 padding10 bgWhite corner10">
  
      <section class="col" id="noRecords"  style="display: none;">
          <%- include('icons/notFound') %>
          <p class="size18 str400">Sorry, No Record Found!</p>
      </section>
  <% if (logs.length === 0) { %>
      <div class="col gap5 height100 textCenter"> 
          <%- include('icons/notFound') %>
          <p class="size20">No logs found!</p>
      </div>
  <% } else { %>
      <table class="porcelain corner10 bgWhite width100"  id="dirTable">
          <thead>
              <tr>
                  <th class="width15 textLeft">Date & Time</th>
                  <th class="width100 textLeft inline" style="display: inline;">User & Action</th>
              </tr>
          </thead>
          <tbody>
              <% logs.forEach((log, index) => { %>
                <% if (log.who !== 'NEW VISIT' || user.role === 'Dev') { %>
                  <tr class="padding2">
                    <td class=""><%= log.createdAtFormatted %></td>
                    <td class="inline width100">
                        <strong><%= log.who %></strong> &nbsp; <%= log.what %>
                    </td>
                  </tr>
                <% } %>
              <% }) %>
          </tbody>
      </table>
  <% } %>
</div>

<div class="sub height10 padding15">
    <div class="width20 justifyStart">
        <span id="totalRecords" class="totalRecords"></span>
    </div>
    <div class="width80 justifyEnd gap5" id="trail">
        <p>
            Display Per Page:
        </p>
        <div class="selectBar" style="width: 70px;"> 
            <select id="rowsPerPage" onchange="updateRowsPerPage()" style="width: 100px">
                <option value="12">12</option>
                <option value="20">20</option>
                <option value="50">50</option>
                <option value="100">100</option>
                <option value="1000000000000">All</option>
            </select>
        </div>
        <div class="pagination" id="pagination"></div>
    </div>
</div>


   
<script>document.addEventListener("DOMContentLoaded", function() {
    const dirTable = document.getElementById("dirTable");
    const tableBody = dirTable.getElementsByTagName("tbody")[0];
    const paginationContainer = document.getElementById("pagination");
    const rowsPerPageSelect = document.getElementById("rowsPerPage");
    const totalRecordsLabel = document.getElementById("totalRecords");
    const searchInput = document.getElementById("univ");
    const noRecordsMessage = document.getElementById("noRecords");
    const subDiv = document.querySelector(".sub");

    let currentPage = 1;
    let rowsPerPage = parseInt(rowsPerPageSelect.value);
    let allRows = Array.from(tableBody.rows);
    let filteredRows = allRows;

    function renderTable() {
        const start = (currentPage - 1) * rowsPerPage;
        const end = start + rowsPerPage;

        if (filteredRows.length === 0) {
            dirTable.style.display = "none";
            noRecordsMessage.style.display = "flex";
        } else {
            dirTable.style.display = "table";
            noRecordsMessage.style.display = "none";
        }

        if (filteredRows.length <= 12) {
            subDiv.style.display = "none";
        } else {
            subDiv.style.display = "flex";
        }

        allRows.forEach(row => (row.style.display = "none"));
        filteredRows.slice(start, end).forEach(row => (row.style.display = ""));

        totalRecordsLabel.innerText = `Showing ${filteredRows.length} Records`;
        renderPagination(filteredRows.length);
    }
 
function renderPagination(totalRows) {
    paginationContainer.innerHTML = "";

    if (searchInput.value.trim()) return;

    const totalPages = Math.ceil(totalRows / rowsPerPage);
    if (totalPages <= 1) return;

    // Previous Button
    const prevButton = document.createElement("button");
    prevButton.innerHTML = "« Previous";
    prevButton.disabled = currentPage === 1;
    prevButton.onclick = () => {
        currentPage--;
        renderTable();
        renderPagination(totalRows); // Re-render pagination after page change
    };
    paginationContainer.appendChild(prevButton);

    // --- New Logic for displaying a limited number of page buttons ---

    // Display all buttons if total pages are 7 or less
    if (totalPages <= 7) {
        for (let i = 1; i <= totalPages; i++) {
            const pageButton = document.createElement("button");
            pageButton.innerHTML = i;
            pageButton.className = i === currentPage ? "active" : "";
            pageButton.onclick = () => {
                currentPage = i;
                renderTable();
                renderPagination(totalRows);
            };
            paginationContainer.appendChild(pageButton);
        }
    } else { // Display condensed pagination for more than 7 pages
        const startPages = [1, 2, 3];
        const endPages = [totalPages - 2, totalPages - 1, totalPages];
        const middlePages = [currentPage - 1, currentPage, currentPage + 1];

        // Function to create a page button
        const createPageButton = (page, isEllipsis = false) => {
            const btn = document.createElement("button");
            btn.innerHTML = isEllipsis ? "..." : page;
            btn.disabled = isEllipsis;
            if (!isEllipsis) {
                btn.className = page === currentPage ? "active" : "";
                btn.onclick = () => {
                    currentPage = page;
                    renderTable();
                    renderPagination(totalRows);
                };
            }
            return btn;
        };

        // Add first pages
        for (const page of startPages) {
            if (page <= totalPages) {
                paginationContainer.appendChild(createPageButton(page));
            }
        }
        
        // Add ellipsis if current page is not near the start
        if (currentPage > 4) {
            paginationContainer.appendChild(createPageButton("...", true));
        }

        // Add middle pages (current page and its neighbors)
        if (currentPage > 3 && currentPage < totalPages - 2) {
            for (const page of middlePages) {
                if (page > 0 && page <= totalPages) {
                    paginationContainer.appendChild(createPageButton(page));
                }
            }
        }

        // Add ellipsis if current page is not near the end
        if (currentPage < totalPages - 3) {
            paginationContainer.appendChild(createPageButton("...", true));
        }

        // Add last pages
        for (const page of endPages) {
            if (page > 3) {
                paginationContainer.appendChild(createPageButton(page));
            }
        }
    }

    // Next Button
    const nextButton = document.createElement("button");
    nextButton.innerHTML = "Next »";
    nextButton.disabled = currentPage === totalPages;
    nextButton.onclick = () => {
        currentPage++;
        renderTable();
        renderPagination(totalRows); // Re-render pagination after page change
    };
    paginationContainer.appendChild(nextButton);
}

    function updateRowsPerPage() {
        rowsPerPage = parseInt(rowsPerPageSelect.value);
        currentPage = 1;
        renderTable();
    }

    function searchTable() {
        const query = searchInput.value.toLowerCase().trim();
        filteredRows = allRows.filter(row =>
            Array.from(row.cells).some(cell => cell.textContent.toLowerCase().includes(query))
        );

        currentPage = 1;
        //rowsPerPageSelect.style.display = query ? "none" : "block";
        renderTable();
    }

    rowsPerPageSelect.addEventListener("change", updateRowsPerPage);
    searchInput.addEventListener("input", searchTable);
    renderTable();
});
</script>

