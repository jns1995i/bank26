<% layout('layout') %>


<section class="justifyBetween">
  <p class="size30 medium">Book Transactions</p>
  <div class="area0 padding0 gap10">
    <input type="search" class="marginLeft5" name="" id="univ" placeholder="Search here ..">
    <a href="javascript:void(0)" class="nav pnav" id="newTRbtn"><i class="fas fa-plus"></i> Add Record</a>
  </div>
</section>

<br>

<p class="noFound noteGray size18 width0" style="display:none;">No results found.</p>

<table cellpadding="10" class="tCard" id="book">
  <thead>
    <tr style="background-color: #f2f2f2;">
      <th class="width10">Date</th>
      <th class="width8">Fund</th>
      <th class="width10">Voucher No.</th>
      <th class="width10">Check No.</th>
      <th class="width20">Description/Payee</th>
      <th class="width14">Amount</th>
      <th class="width8">Type</th>
      <th class="width10">Status</th>
      <th class="width10">Action</th>
    </tr>
  </thead>
  <tbody>
    <% if (trs && trs.length) { %>
      <% trs.forEach(tr => { %>
        <tr>
          <td><%= tr.dateFormatted %></td>
          <td><strong><%= tr.accountType %></strong></td> <td><%= tr.voucherNo || 'N/A' %></td>
          <td><%= tr.checkNo || '---' %></td>
          <td><%= tr.desc %></td>
          <td><%= tr.amount.toLocaleString(undefined, { minimumFractionDigits: 2 }) %></td>
          <td><%= tr.type %></td>
          <td>
             <span class="<%= tr.status === 'Reconciled' ? 'noteGreen' : 'noteGray' %>">
               <%= tr.status %>
             </span>
          </td>
          <td class="">
           <a href="javascript:void(0)" class="inline editBtn nav corner10"
            data-id="<%= tr._id %>"
            data-date="<%= tr.date.toISOString().split('T')[0] %>"
            data-accounttype="<%= tr.accountType %>"
            data-voucherno="<%= tr.voucherNo %>"
            data-checkno="<%= tr.checkNo %>"
            data-desc="<%= tr.desc %>"
            data-amount="<%= tr.amount %>"
            data-type="<%= tr.type %>">
            <i class="fas fa-pen"></i>
          </a>
          &nbsp;
           <a href="javascript:void(0)" class="inline delBtn nav corner10"
            data-id="<%= tr._id %>"
            data-date="<%= tr.date.toISOString().split('T')[0] %>"
            data-accounttype="<%= tr.accountType %>"
            data-voucherno="<%= tr.voucherNo %>"
            data-checkno="<%= tr.checkNo %>"
            data-desc="<%= tr.desc %>"
            data-amount="<%= tr.amount %>"
            data-type="<%= tr.type %>">
            <i class="fas fa-trash"></i>
          </a>
          </td>
        </tr>
      <% }) %>
    <% } else { %>
      <tr><td colspan="8" style="text-align:center;">No transactions found.</td></tr>
    <% } %>
  </tbody>
</table>

<script>
document.addEventListener('DOMContentLoaded', () => {
  // Select all delete buttons
  const deleteBtns = document.querySelectorAll('.delBtn');

  deleteBtns.forEach(btn => {
    btn.addEventListener('click', (e) => {
      e.preventDefault();

      // Ask for confirmation
      const confirmDelete = confirm('Are you sure you want to delete this transaction?');

      if (!confirmDelete) return;

      // Create a form dynamically to submit the deletion
      const form = document.createElement('form');
      form.method = 'POST';
      form.action = '/deleteTR';

      // Hidden input with the ID of the transaction
      const input = document.createElement('input');
      input.type = 'hidden';
      input.name = 'id';
      input.value = btn.dataset.id;

      form.appendChild(input);
      document.body.appendChild(form);

      form.submit(); // Submit the form
    });
  });
});
</script>



<div class="col fixed right20 bgWhite shadow2 justifyStart top0 padding20 unseen" id="newTRCard">
    <form action="/newTR" method="POST" class="">

        <div class="field">
            <p class="size30 medium">Add New Record</p>
        </div>

        <div class="field">
            <label for="">Date</label>
            <input type="date" name="date" required>
        </div>

        <div class="field">
            <label for="">Account / Fund Type</label>
            <select name="accountType" required>
                <option value="">-- Select Fund --</option>
                <option value="GOF">GOF (General Operating Fund)</option>
                <option value="CPF">CPF (Corporate Partnership Fund)</option>
                <option value="RCA">RCA (Rice Collection Account)</option>
                <option value="MSC">MSC (Miscellaneous)</option>
            </select>
        </div>

        <div class="field">
            <label for="">Voucher No.</label>
            <input type="text" name="voucherNo" placeholder="e.g. 25-11-1496">
        </div>

        <div class="field">
            <label for="">Check No.</label>
            <input type="text" name="checkNo" placeholder="e.g. 1723917">
        </div>

        <div class="field">
            <label for="">Description / Remarks</label>
            <textarea name="desc" required placeholder="Who was paid and for what?"></textarea>
        </div>

        <div class="field">
            <label for="">Amount</label>
            <input type="number" name="amount" step="0.01" required placeholder="0.00">
        </div>

        <div class="field">
            <label for="">Entry Type:</label>
            <select name="type" required>
                <option value="Debit">Debit (Receipts)</option>
                <option value="Credit">Credit (Disbursement)</option>
            </select>
        </div>
        <br>

        <div class="height0 justifyBetween padding0">
            <a href="" class="nav wpx150">Cancel</a>
            <button class="nav wpx150 pnav" type="submit">Add to Record</button>
        </div>

    </form>

</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const btn = document.getElementById('newTRbtn');
    const card = document.getElementById('newTRCard');

    if (!btn || !card) return;

    btn.addEventListener('click', (e) => {
      e.stopPropagation();
      card.classList.remove('unseen');
      card.classList.add('seen');
    });

    card.addEventListener('click', (e) => {
      e.stopPropagation();
    });

    document.addEventListener('click', () => {
      card.classList.remove('seen');
      card.classList.add('unseen');
    });
  });
</script>

<script>
const searchInput = document.getElementById('univ');
const table = document.querySelector('.tCard');          // ✅ table
const rows = document.querySelectorAll('.tCard tbody tr');
const noFound = document.querySelector('.noFound');

searchInput.addEventListener('input', () => {
    const query = searchInput.value.toLowerCase();
    let visibleCount = 0;

    rows.forEach(row => {
        if (row.textContent.toLowerCase().includes(query)) {
            row.style.display = '';
            visibleCount++;
        } else {
            row.style.display = 'none';
        }
    });

    // ✅ toggle table + noFound
    if (visibleCount === 0) {
        table.style.display = 'none';
        noFound.style.display = 'block';
    } else {
        table.style.display = '';
        noFound.style.display = 'none';
    }
});
</script>

<div class="col fixed centerAll bgWhite shadow2 justifyStart top0 right20 padding20 unseen" id="editTRCard">
  <form action="/editTR" method="POST">
    <input type="hidden" name="id" id="editTRId">

    <div class="field">
      <p class="size30 medium">Edit Record</p>
    </div>

    <div class="field">
      <label for="">Date</label>
      <input type="date" name="date" id="editDate" required>
    </div>

    <div class="field">
      <label for="">Account / Fund Type</label>
      <select name="accountType" id="editAccountType" required>
        <option value="">-- Select Fund --</option>
        <option value="GOF">GOF (General Operating Fund)</option>
        <option value="CPF">CPF (Corporate Partnership Fund)</option>
        <option value="RCA">RCA (Rice Collection Account)</option>
        <option value="MSC">MSC (Miscellaneous)</option>
      </select>
    </div>

    <div class="field">
      <label for="">Voucher No.</label>
      <input type="text" name="voucherNo" id="editVoucherNo" placeholder="e.g. 25-11-1496">
    </div>

    <div class="field">
      <label for="">Check No.</label>
      <input type="text" name="checkNo" id="editCheckNo" placeholder="e.g. 1723917">
    </div>

    <div class="field">
      <label for="">Description / Remarks</label>
      <textarea name="desc" id="editDesc" required></textarea>
    </div>

    <div class="field">
      <label for="">Amount</label>
      <input type="number" name="amount" id="editAmount" step="0.01" required>
    </div>

    <div class="field">
      <label for="">Entry Type:</label>
      <select name="type" id="editType" required>
          <option value="Debit">Debit (Receipts)</option>
          <option value="Credit">Credit (Disbursement)</option>
      </select>
    </div>

    <br>
    <div class="height0 justifyBetween padding0">
      <a href="javascript:void(0)" class="nav wpx150" id="cancelEdit">Cancel</a>
      <button class="nav wpx150 pnav" type="submit">Save Changes</button>
    </div>
  </form>
</div>
<script>
 document.addEventListener('DOMContentLoaded', () => {
  const editCard = document.getElementById('editTRCard');
  const cancelBtn = document.getElementById('cancelEdit');

  // Open Edit Modal
  document.querySelectorAll('.editBtn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      e.stopPropagation(); // important

      editCard.classList.remove('unseen');
      editCard.classList.add('seen');

      // Populate form
      document.getElementById('editTRId').value = btn.dataset.id;
      document.getElementById('editDate').value = btn.dataset.date; // YYYY-MM-DD ✅
      document.getElementById('editAccountType').value = btn.dataset.accounttype;
      document.getElementById('editVoucherNo').value = btn.dataset.voucherno || '';
      document.getElementById('editCheckNo').value = btn.dataset.checkno || '';
      document.getElementById('editDesc').value = btn.dataset.desc || '';
      document.getElementById('editAmount').value = btn.dataset.amount || 0;
      document.getElementById('editType').value = btn.dataset.type;
    });
  });

  // Close Edit Modal
  cancelBtn.addEventListener('click', () => {
    editCard.classList.remove('seen');
    editCard.classList.add('unseen');
  });

  // Close if clicking outside
  document.addEventListener('click', (e) => {
    if (!editCard.contains(e.target) && !e.target.classList.contains('editBtn')) {
      editCard.classList.remove('seen');
      editCard.classList.add('unseen');
    }
  });

  // Prevent click inside modal from closing it
  editCard.addEventListener('click', e => e.stopPropagation());
});


</script>
