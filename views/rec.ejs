<% layout('layout') %>

<section class="padding5 alignStart hidden">
    <div class="shadow1 corner5 bgWhite relative col justifyStart colorPrimary padding50" id="report" style="height: 1056px !important; width: 816px !important;">
        <img src="/images/logo.png" alt="" class="absolute hpx100 left25 top25">
        <img src="/images/pilipinas.png" alt="" class="absolute hpx100 right25 top25">
        <section class="padding0 col">
            <p class="size16 str5">BANK RECONCILIATION STATEMENT</p>
            <p class="size16 str5">GENERAL OPERATING FUND</p>
            <p class="size16 str5">NATIONAL FOOD AUTHORITY - BULACAN BRANCH OFFICE</p>
            <p class="size16 str5">As of <%= data.asOfDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' }) %></p>
        </section>
        <br>

        <div class="height0 col alignStart justifyStart padding15 gap10 borderStone400 border1 corner10">
            <p class="size16 str5">Bank Side</p>
            <p class="size16 justifyBetween width100">
                <span>Unadjusted Bank Balance</span>
                <strong><%= data.bankBal.toLocaleString(undefined, { minimumFractionDigits: 2 }) %></strong>
            </p>
            <p class="size16 justifyBetween width100">
                <span>Less: Outstanding Checks</span>
                <span>(<%= data.totalOC.toLocaleString(undefined, { minimumFractionDigits: 2 }) %>)</span>
            </p>
            <p class="size16 justifyBetween width100">
                <span>Add: Deposits in Transit</span>
                <span><%= data.totalDeposits.toLocaleString(undefined, { minimumFractionDigits: 2 }) %></span>
            </p>
            <hr>
            <p class="size16 justifyBetween width100 str5">
                <span>Adjusted Bank Balance</span>
                <strong><%= data.adjBank.toLocaleString(undefined, { minimumFractionDigits: 2 }) %></strong>
            </p>
        </div>

        <br>

        <div class="height0 col alignStart justifyStart padding15 gap10 borderStone400 border1 corner10">
            <p class="size16 str5">Book Side</p>
            <p class="size16 justifyBetween width100">
                <span>Unadjusted Book Balance</span>
                <strong><%= data.bookBal.toLocaleString(undefined, { minimumFractionDigits: 2 }) %></strong>
            </p>
            <p class="size16 justifyBetween width100">
                <span>Add/Deduct: Reconciling Items</span>
                <span>0.00</span>
            </p>
            <hr>
            <p class="size16 justifyBetween width100 str5">
                <span>Adjusted Book Balance</span>
                <strong><%= data.bookBal.toLocaleString(undefined, { minimumFractionDigits: 2 }) %></strong>
            </p>
        </div>

        <br><br>
        <section class="padding0 col alignStart">
            <p class="size16 str4">Prepared By:</p>
            <br>
            <p class="size16 str5">Xai Danielle F. Bulauitan</p>
            <p class="size16 str4">Accountant III</p>
        </section>
    </div>
</section>

<section class="width100 justifyBetween corner10 bgWhite">
    <p class="size30 str5">Bank Reconciliation Statement</p>
    <div class="area0 gap10">
        <a href="javascript:void(0)" class="nav" id="settingBtn"><i class="fas fa-cog"></i> Set Ending</a>
        |
        <a href="javascript:void(0)" class="nav bgBlue900" id="importBtn"><i class="fas fa-file-excel"></i> Import Report</a>
        <a href="javascript:void(0)" class="nav bgRed700" id="exportPdf"><i class="fas fa-file-download"></i> Export Report</a>
    </div>
</section>

<br>

<div class="width25 height100 fixed right20 top0 padding20 shadow2 col index50 bgWhite unseen" id="settingCard">
    <form action="/update-settings" method="POST">
        <input type="hidden" name="accountType" value="<%= data.accountType %>">
        
        <p class="size20 str5">Manual Balance Setting</p>
        <p class="size12 noteGray">Set the unadjusted balances as per statement/ledger [cite: 1, 4]</p>
        <br>
        <div class="field">
            <label>Unadjusted Book Balance</label>
            <input type="number" step="0.01" name="bookBeginning" value="<%= data.settings.bookBeginning %>" required>
        </div>
        <br>
        <div class="field">
            <label>Unadjusted Bank Balance</label>
            <input type="number" step="0.01" name="bankBeginning" value="<%= data.settings.bankBeginning %>" required>
        </div>
        <br>
        <button type="submit" class="nav pnav width100">Update and Reconcile</button>
    </form>
</div>


    <div class="width35 height100 fixed right20 top0 padding20 shadow2 col index50 bgWhite unseen" id="importCard">
        <p class="size24 medium">Import Monthly Data</p>
        <form action="/importExcel" method="POST" enctype="multipart/form-data">
            <div class="field">
                <label>Select Master Account (for Book/Bank sheets):</label>
                <select name="accountType" class="width100 padding10">
                    <option value="GOF">GOF (General Operating Fund)</option>
                    <option value="CPF">CPF (Cereal Procurement Fund)</option>
                    <option value="RCA">RCA (Rice Collection Account)</option>
                </select>
            </div>
            <section class="col borderStone400 border05 corner10 alignStart textLeft padding20">
                <p class="size12"><i class="fas fa-exclamation-triangle"></i> CRITICAL: Use the Correct Excel Format</p>
                <br>
                <p class="size12">The system will only read your file if the sheets are named exactly as follows:</p>
                <br>
                <p class="size12"><i class="fas fa-check-circle"></i> Sheet "book":</strong> Put your <u>Bank Statement</u> here. (Cols: Date, Desc, Debit, Credit, Balance, Branch, Check No)</p><br>
                <p class="size12"><i class="fas fa-check-circle"></i> Sheet "bank":</strong> Put your <u>General Ledger</u> here. (Cols: Date, Payee, Particulars, Check No, Dr, Cr, Balance)</p><br>
                <p class="size12"><i class="fas fa-check-circle"></i> Sheet "oc":</strong> Put your <u>Outstanding Checks</u> here. (Cols: Date, Payee, Check #, Particulars, Amount)</p><br>
                <br>
                <p class="size12">Note: Headers must start on Row 1. Do not leave empty rows at the top.</p>
            </section>
            <div class="field">
                <input type="file" name="excelFile" accept=".xlsx, .xls" required>
            </div>
            <button type="submit" class="nav pnav width100">Upload and Process</button>
        </form>
    </div>


<div class="height0 gap15 alignStart corner10 padding0">
    <div class="col alignStart justifyStart padding0 gap10">
        <table style="width: 100%;">
            <tr><th colspan="2" class="bgBlue100 border0">Bank Side</th></tr>
            <tr>
                <td>Unadjusted Bank Balance</td>
                <td class="text-right"><strong><%= data.bankBal.toLocaleString(undefined, {minimumFractionDigits: 2}) %></strong></td>
            </tr>
            <tr>
                <td>Less: Outstanding Checks</td>
                <td class="text-right">(<%= data.totalOC.toLocaleString(undefined, {minimumFractionDigits: 2}) %>)</td>
            </tr>
            <tr>
                <td>Add: Deposits in Transit</td>
                <td class="text-right"><%= data.totalDeposits.toLocaleString(undefined, {minimumFractionDigits: 2}) %></td>
            </tr>
            <tr style="border-top: 2px solid #000;">
                <td><strong>Adjusted Bank Balance</strong></td>
                <td class="text-right"><strong><%= data.adjBank.toLocaleString(undefined, {minimumFractionDigits: 2}) %></strong></td>
            </tr>
        </table>
    </div>

    <div class="col alignStart justifyStart paddin0 gap10">
        <table style="width: 100%;">
            <tr><th colspan="2" class="bgRed100 border0">Book Side</th></tr>
            <tr>
                <td>Unadjusted Book Balance</td>
                <td class="text-right"><strong><%= data.bookBal.toLocaleString(undefined, {minimumFractionDigits: 2}) %></strong></td>
            </tr>
            <tr style="border-top: 2px solid #000;">
                <td><strong>Adjusted Book Balance</strong></td>
                <td class="text-right"><strong><%= data.bookBal.toLocaleString(undefined, {minimumFractionDigits: 2}) %></strong></td>
            </tr>
        </table>
    </div>
</div>
<br>

<section class="justifyBetween gap10 bgWhite corner10">
    <div class="area0 gap10">
        <% if(Math.abs(data.diff) < 0.01) { %>
            <p class="noteGreen size16 width0"> STATUS: BALANCED <i class="fas fa-check-circle"></i></p>
        <% } else { %>
            <p class="noteRed size16 width0"> DISCREPANCY FOUND <i class="fas fa-xmark-circle"></i></p>
        <% } %>
    </div>
    <p class="str5 size16">Difference: <%= data.diff.toLocaleString(undefined, {minimumFractionDigits: 2}) %></p>
</section>
<br>

<p class="size18 str5 marginLeft10 marginBottom10">Outstanding Checks</p>
<section class="gap10 col block alignStart overflowY hpx300 corner10 border05 borderStone300 bgWhite">
    <table class="table" id="outstanding">
        <thead>
            <tr>
                <th>Source</th>
                <th>Date</th>
                <th>Check No.</th>
                <th>Particulars</th>
                <th>Amount</th>
            </tr>
        </thead>
        <tbody>
            <% if (data.allOutstanding && data.allOutstanding.length > 0) { %>
                <% data.allOutstanding.forEach(oc => { %>
                    <tr>
                        <td>
                            <% if (oc.voucherNo) { %>
                                <span class="noteGray">CURRENT</span>
                            <% } else { %>
                                <span class="noteOrange">PREVIOUS</span>
                            <% } %>
                        </td>
                        <td><%= oc.date ? new Date(oc.date).toDateString() : 'N/A' %></td>
                        <td><%= oc.checkNo %></td>
                        <td><%= oc.description || oc.desc || oc.payee || '---' %></td>
                        <td class="text-right">
                            <%= (oc.amount || 0).toLocaleString(undefined, {minimumFractionDigits: 2}) %>
                        </td>
                    </tr>
                <% }) %>
            <% } else { %>
                <tr>
                    <td colspan="5" class="center noteGray">No outstanding checks found.</td>
                </tr>
            <% } %>
        </tbody>
    </table>
</section>

<br>

<p class="size18 str5 marginLeft10 marginBottom10">Deposits in Transit</p>
<section class="gap10 col block alignStart overflowY hpx200 corner10 border05 borderStone300 bgWhite">
    <table class="table" id="deposit">
        <thead>
            <tr>
                <th>Date</th>
                <th>Reference</th>
                <th>Particulars</th>
                <th>Amount</th>
            </tr>
        </thead>
        <tbody>
            <% if(data.depositsInTransit.length > 0) { %>
                <% data.depositsInTransit.forEach(d => { %>
                    <tr>
                        <td><%= d.date.toDateString() %></td>
                        <td><%= d.checkNo || '-' %></td>
                        <td><%= d.desc %></td>
                        <td class="text-right"><%= d.amount.toLocaleString(undefined, {minimumFractionDigits: 2}) %></td>
                    </tr>
                <% }) %>
            <% } else { %>
                <tr><td colspan="4" class="text-center">No deposits in transit.</td></tr>
            <% } %>
        </tbody>
    </table>
</section>

<br>

<p class="size18 str5 marginLeft10 marginBottom10">Reconciling Items</p>
<section class="gap10 col block alignStart overflowY hpx200 corner10 border05 borderStone300 bgWhite">
    <table class="table" id="reconciling">
        <thead>
            <tr>
                <th>Date</th>
                <th>Check/Ref No.</th>
                <th>Particulars</th>
                <th>Type</th>
                <th>Amount</th>
            </tr>
        </thead>
        <tbody>
            <% if(data.reconcilingItems.length > 0) { %>
                <% data.reconcilingItems.forEach(d => { %>
                    <tr>
                        <td><%= d.date.toDateString() %></td>
                        <td><%= d.checkNo || '-' %></td>
                        <td><%= d.desc %></td>
                        <td><%= d.type %></td>
                        <td class="text-right"><%= d.amount.toLocaleString(undefined, {minimumFractionDigits: 2}) %></td>
                    </tr>
                <% }) %>
            <% } else { %>
                <tr><td colspan="5" class="text-center">No reconciling items.</td></tr>
            <% } %>
        </tbody>
    </table>
</section>

<div style="display: none;">
    <table id="book">
        <thead>
            <tr>
                <th>Date</th>
                <th>Fund</th>
                <th>Voucher No.</th>
                <th>Check No.</th>
                <th>Description/Payee</th>
                <th>Amount</th>
                <th>Type</th>
                <th>Status</th>
            </tr>
        </thead>
        <tbody>
            <% trs.forEach(tr => { %>
                <tr>
                    <td><%= tr.dateFormatted %></td>
                    <td><%= tr.accountType %></td>
                    <td><%= tr.voucherNo || 'N/A' %></td>
                    <td><%= tr.checkNo || 'N/A' %></td>
                    <td><%= tr.description %></td>
                    <td><%= tr.amount %></td>
                    <td><%= tr.type %></td>
                    <td><%= tr.status %></td>
                </tr>
            <% }) %>
        </tbody>
    </table>

    <table id="bank">
        <thead>
            <tr>
                <th>Date</th>
                <th>Fund</th>
                <th>Check No.</th>
                <th>Description</th>
                <th>Amount</th>
                <th>Type</th>
                <th>Status</th>
            </tr>
        </thead>
        <tbody>
            <% bankTrs.forEach(tr => { %>
                <tr>
                    <td><%= tr.dateFormatted %></td>
                    <td><%= tr.accountType %></td>
                    <td><%= tr.checkNo || 'N/A' %></td>
                    <td><%= tr.description %></td>
                    <td><%= tr.amount %></td>
                    <td><%= tr.type %></td>
                    <td><%= tr.status %></td>
                </tr>
            <% }) %>
        </tbody>
    </table>
</div>

<script>
document.getElementById('exportPdf').addEventListener('click', async () => {
    // PDF Export Logic
    const { jsPDF } = window.jspdf;
    const report = document.getElementById('report');
    const wrapper = report.closest('.hidden');
    wrapper.classList.remove('hidden');
    
    const canvas = await html2canvas(report, { scale: 2 });
    const imgData = canvas.toDataURL('image/png');
    const pdf = new jsPDF('p', 'pt', 'letter');
    pdf.addImage(imgData, 'PNG', 0, 0, pdf.internal.pageSize.getWidth(), (canvas.height * pdf.internal.pageSize.getWidth()) / canvas.width);
    pdf.save('Bank-Reconciliation.pdf');
    wrapper.classList.add('hidden');

    // Excel Export Logic (Revised Sheet Names)
    const wb = XLSX.utils.book_new();
    const tables = [
        { el: 'outstanding', name: 'Outstanding Checks' },
        { el: 'deposit', name: 'Deposits in Transit' },
        { el: 'reconciling', name: 'Reconciling Items' }, // Renamed from Discrepancies
        { el: 'bank', name: 'Bank Side' },
        { el: 'book', name: 'Book Side' }
    ];

    tables.forEach(t => {
        const table = document.getElementById(t.el);
        if (table) {
            const ws = XLSX.utils.table_to_sheet(table);
            XLSX.utils.book_append_sheet(wb, ws, t.name);
        }
    });
    XLSX.writeFile(wb, 'Bank-Reconciliation-Report.xlsx');
});
</script>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    // Function to handle toggle logic
    const setupToggle = (btnId, cardId) => {
      const btn = document.getElementById(btnId);
      const card = document.getElementById(cardId);

      if (!btn || !card) return;

      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        
        // Optional: Close other open cards before opening this one
        document.querySelectorAll('.seen').forEach(openCard => {
            if(openCard !== card) {
                openCard.classList.replace('seen', 'unseen');
            }
        });

        card.classList.remove('unseen');
        card.classList.add('seen');
      });

      card.addEventListener('click', (e) => {
        e.stopPropagation();
      });
    };

    // Initialize for Import
    setupToggle('importBtn', 'importCard');
    
    // Initialize for Settings
    setupToggle('settingBtn', 'settingCard');

    // Global click to close any open card
    document.addEventListener('click', () => {
      const openCards = document.querySelectorAll('.seen');
      openCards.forEach(card => {
        card.classList.remove('seen');
        card.classList.add('unseen');
      });
    });
  });
</script>
