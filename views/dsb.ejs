<% layout('layout') %>
<style>
    .mainf {
        padding: 5px 15px;
    }
    .keyMetrics {
      border-radius: 15px;
      flex-direction: column;
      align-items: start;
      justify-content: space-between;
      position: relative;
      padding: 20px;
      height: auto;
    }
    .keyIcon {
      position: absolute;
      right: 5px;
      top: 5px;
      transform: rotate(-45deg);
      i {
        transform: rotate(45deg);
      }
    }
    #registrationGrowth {
      i {
        font-size: 10px;
        height: 12px;
      }
    }

</style>

<%
  const statColor = {
    Quick: "bgViolet100",
    Fast: "bgGreen100",
    Moderate: "bgBlue100",
    Standard: "bgBlue100",
    Slow: "bgOrange100",
    Warning: "bgRed100",
    Critical: "bgRed200"
  };
%>
<section class="gap15 height0 padding0 alignStretch">
  <section class="height0 col width70 justifyBetween padding0">
    <section class="relative justifyBetween padding0">
      <p class="size40 str400" id="">Dashboard</p>
      <% if (user.role === "Head" || user.role === "Admin") { %>
        <section class="gap0 padding0 width0">
          <section class="width0 relative">
            <a href="/srv" class="nav"><i class="fas fa-bell"></i> Pending Requests &nbsp;</a>
            <% if ( analytics.pending !== 0 ) { %>
              <div id="pending" class="marginLeft5 divCenter bgOrange w23 h23 white corner500 str500 absolute right0 top5"></div>
            <% } %>
          </section>
          <section class="width0 relative">
            <a href="/vrf" class="nav"><i class="fas fa-user-check"></i> To Verify &nbsp;</a>
            <% if ( analytics.toVerifyUsers !== 0 ) { %>
              <div id="toVerifyUsers" class="marginLeft5 divCenter bgOrange w23 h23 white corner500 str500 absolute right0 top5"> 0</div>
            <% } %>
          </section>
        </section>
      <% } else if (user.role === "Registrar") { %>
        <section class="gap5 padding0 width0">
          <a href="/srv" class="nav"><i class="fas fa-bell"></i> Pending Requests <div id="myPending" class="marginLeft5 divCenter bgTint6 w18 h18 white corner500 str500"> 0</div></a>
        </section>
      <% } else { %>
      <% } %>
    </section>
    <section class="gap20 padding0 corner15" id="metricsContainer">
      <section id="metric" class="keyMetrics bgWhite gap10">
          <p class="size20 str400 flex justifyCenter alignCenter">
              <i class="icon bgBlue100 border0 size12 corner5 marginRight5" style="min-width: 20px !important; height: 20px;"></i> <span class="label size18"></span>
          </p>
          <p class="size24 str500 marginLeft5 value"></p>
          <p class="size20 str500 percentage hidden"></p>
      </section>
    </section>
  </section>
  <section class="height0 col width30 padding10 relative corner15 gradient">
    <section class=" corner15 col alignStart justifyBetween padding15">
      <p class="size20">Need Report?</p>
      <br>
      <a href="/rpt" class="nav liquid"><i class="fas fa-file"></i> Generate Here</a>
    </section>
    <img src="/images/gold.png" alt="" class="height85 absolute bottom10 right10" style="filter:brightness(2); transform: rotate(-1deg);">
  </section>
</section>
<br>

<section class="col corner15 bgWhite padding0 relative">
  <section class="justifyBetween paddingInline15">
    <section class="padding0 width0 gap5">
      <p class="size30 str400" id="totalRequests"></p>
    </section>
    <section class="width0 gap10 padding0">
      <div class="selectBar w200">
          <i class="fas fa-filter"></i>
          <select id="filterSelect">
          <option value="" disabled>--Filter</option>
          <option value="today">Today</option>
          <option value="yesterday">Yesterday</option>
          <option value="thisWeek">This Week</option>
          <option value="lastWeek">Last Week</option>
          <option value="thisMonth" selected>This Month</option>
          <option value="lastMonth">Last Month</option>
          <option value="thisYear">This Year</option>
          <option value="lastYear">Last Year</option>
          <option value="specific">Specific Date</option>
          <option value="custom">Custom Range</option>
          <option value="overall">Overall</option>
          </select>
      </div>
      <input type="date" id="specificDate" style="display:none;" class="w160" />
      <input type="date" id="customStart" style="display:none;" class="w160" />
      <input type="date" id="customEnd" style="display:none;" class="w160" />
    </section>
  </section>
  <section class="h250 corner15 bgWhite padding0">
      <canvas id="trendChart"></canvas>
  </section>
  <section class="width0 absolute right20 top55 bgBlue100 border0" style="display: none;"><p class="size12" id="filterInfo"></p></section>
  
</section>
<script>
const filterSelect = document.getElementById("filterSelect");
const specificDate = document.getElementById("specificDate");
const customStart = document.getElementById("customStart");
const customEnd = document.getElementById("customEnd");

filterSelect.addEventListener("change", () => {
    const value = filterSelect.value;

    // Hide everything by default
    specificDate.style.display = "none";
    customStart.style.display = "none";
    customEnd.style.display = "none";

    if (value === "specific") {
        specificDate.style.display = "inline-block";
    } else if (value === "custom") {
        customStart.style.display = "inline-block";
        customEnd.style.display = "inline-block";
    }
});

</script>

<br>
<section class="corner15 bgWhite padding0 relative alignStretch">
  <div class="width30 col padding10 gap20 height0">
    <div class="bgWhite shadow1 corner15 padding20 col alignStart justifyBetween">
      <p class="size16 str400">Total Revenue</p>
      <p class="size20 str400" id="totalRevenue"></p>
    </div>
    <div class="bgWhite shadow1 corner15 padding20 col alignStart justifyBetween">
      <p class="size16 str400">Total Paper Used</p>
      <p class="size20 str400" id="totalPaper"></p>
    </div>
    <div class="bgWhite shadow1 corner15 padding20 col alignStart justifyBetween">
      <p class="size16 str400">Average Ratings <span class="bgBlue100 border0" id="totalRatings"></span></p>
      <p class="size20 str400" id="avgRating"></p>
    </div>
  </div>
  <section class="width70 corner15 bgWhite padding0">
      <canvas id="revenueChart"></canvas>
  </section>
</section>

<br>

<section class="bgWhite corner15 gap20 padding20">
  <section class="padding0 gap25 width70 col justifyBetween">
    <section class="padding0 gap20 corner15 bgWhite">
      <section class="col gap5 width50">
        <p class="size30 colorPrimary">Request Status</p>
        <div class="h300 bgWhite corner15 padding0 col"><canvas id="requestStatusStats"></canvas></div>
      </section>
      <div class="padding10 width50 col gap20">
        <section class="porcelain justifyBetween corner8 bgWhite">
          <section href="/perf" class=" width0 size14 padding0 colorPrimary col alignStart">
            <p class="size16">Track Team Performance</p>
            <section class="width0 block padding0">
              &nbsp; &nbsp;
              <% users.forEach(user => { %>
                  <% if ( user.role === "Registrar" || user.role === "Admin") { %>
                      <img src="<%= user.photo ? user.photo : '/images/profile.jpg' %>" alt="Profile" onerror="this.onerror=null; this.src='/images/profile.jpg';" class="h23 w23 corner500 shadow1" style="margin-left: -10px;">
                  <% } %>
              <% }) %>
            </section>
          </section>
          <a href="/perf" class="nav cnav"><i class="bi bi-arrow-up-right"></i></a>
        </section>
        <table class="corner10 porcelain">
          <thead>
            <tr>
              <th class="width50">Status</th>
              <th class="width25 textCenter">Total</th>
              <th class="width25">%</th>
            </tr>
          </thead>
          <tbody id="statusTable"></tbody>
        </table>
      </div>
    </section>
  </section>
  <section class="col porcelain corner15 padding10 gap10 width30">
    <p class="size24 colorPrimary">Average Approval Rate</p>
    <section class="gap10 padding15 col bgWhite corner15">
        <div class="porcelain height0 corner15 col alignStart padding15 relative">
            <p class="size12 str400">Processing Time</p>
            <p class="size16 str500" id="avgApprovalTime"><%= analytics.avgApprovalTime %></p>
            <p class="size12 str500 border0 absolute right10 top10 <%= statColor[analytics.avgApprovalTimeStat] %>" id="avgApprovalTimeStat"></p>
        </div>
        <div class="porcelain height0 corner15 col alignStart padding15 relative">
            <p class="size12 str400">Reviewing Time</p>
            <p class="size16 str500" id="avgReviewTime"><%= analytics.avgReviewTime %></p>
            <p class="size12 str500 border0 absolute right10 top10 <%= statColor[analytics.avgReviewTimeStat] %>" id="avgReviewTimeStat"></p>
        </div>
        <div class="porcelain height0 corner15 col alignStart padding15 relative">
            <p class="size12 str400">Assessment Time</p>
            <p class="size16 str500" id="avgAssessTime"><%= analytics.avgAssessTime %></p>
            <p class="size12 str500 border0 absolute right10 top10 <%= statColor[analytics.avgAssessTimeStat] %>" id="avgAssessTimeStat"></p>
        </div>
    </section>
    <section class="bgWhite corner15 padding15 hidden">
    </section>
  </section>
</section>

<br>
<section class="padding10 gap20 bgWhite corner15 alignStart justifyBetween rowReverse">
  <section class="padding0 gap10 bgWhite corner15 col width40">
    <p class="size30 marginLeft15">Users Overview</p>
    <div class="padding10">
      <table class="corner10 porcelain">
        <thead>
          <tr><th>Type</th><th>Requests</th></tr>
        </thead>
        <tbody id="roleTable"></tbody>
      </table>
    </div>
    <div class="h260 bgWhite corner15 padding0 col alignStart">
      <canvas id="roleChart"></canvas>
    </div>
  </section>
  <section class="bgWhite corner15 padding20 col width50 alignStart">
    <section class="relative bgWhite gap10 justifyStart alignEnd padding0">
      <p class="size14 flex justifyCenter alignCenter absolute right5 top10" id="registrationGrowth"></p>
      <div class="width80 col alignStart justifyStart padding5">
        <p class="size30" id="activeUserCount"></p>
        <p class="size14" id="totalUsers">Out of <%= analytics.totalUsers %> Total Users</p>
        <br>
        <section class="porcelain corner10 gap10 padding5">
          <section class="corner10 col alignStart">
            <p class="size12" id="previousPeriodLabel" class="darkGray"></p>
            <p class="size18" id="previousUsersCount"></p>
          </section>
          <section class="corner10 bgWhite col alignStart">
            <p class="size12" id="currentPeriodLabel" class="darkGray"></p>
            <p class="size18" id="currentUsersCount"></p>
          </section>
        </section>
      </div>
      <div class="width20 col padding10">
        <a href="" class="nav cnavLG hidden"></a>
        <img src="/images/student.png" alt="" class="h100">
      </div>
    </section>
    <br>
    <p class="size30">Top Requestor</p>
    <table class="porcelain">
      <% if (!analytics.topUsers || analytics.topUsers.length === 0) { %>
        <thead><tr><th>No Requestor</th></tr></thead>
      <% } %>
      <tbody id="topUsersTable"></tbody>
    </table>
  </section>
</section>

<br>

<section class="gap20 alignStart bgWhite corner15 justifyBetween rowReverse">
  <section class="width50">
    <div class="porcelain">
      <table>
        <thead>
          <tr><th class="width70">Course</th><th class="width30">Requests</th></tr>
        </thead>
        <tbody id="courseTable"></tbody>
      </table>
    </div>
  </section>
  <section class="padding0 gap20 bgWhite corner15 col width50">
    <div class="h300 bgWhite corner15 padding20 col width55"><canvas id="yearLevelChart"></canvas></div>
    <div class="padding10">
      <table class="corner10 porcelain">
        <thead>
          <tr>
            <th class="width50">Year Level</th>
            <th class="width25 textCenter">Requests</th>
            <th class="width25">%</th>
          </tr>
        </thead>
        <tbody id="yearLevelTable"></tbody>
      </table>
    </div>
  </section>
</section>

<br>

<section class="gap20 alignStart padding0">
  <section class="padding0 gap20 bgWhite corner15 alignStart">
    <div class="h300 bgWhite corner15 padding20 width60 hidden">
      <canvas id="documentChart"></canvas>
    </div>
    <div class="padding15 gap10 col  alignStart">
      <p class="size30">Request per Doc Type</p>
      <table class="corner10 porcelain">
        <thead>
          <tr>
            <th class="width50">Type</th>
            <th class="width10 textCenter">Qty</th>
            <th class="width10 textCenter">Rqst</th>
            <th class="width15 textCenter">Paper</th>
            <th class="width15 textCenter">Rev</th>
          </tr>
        </thead>
        <tbody id="documentStats"></tbody>
      </table>
    </div>
    <div class="h300 bgWhite corner15 padding20 col hidden"><canvas id="courseChart"></canvas></div>
  </section>
  <section class="padding0 gap20 bgWhite corner15 alignStart">
    <div class="h300 bgWhite corner15 padding20 hidden">
      <canvas id="topPurpose"></canvas>
    </div>
    <div class="padding15 gap10 col  alignStart">
      <p class="size30">Request per Doc Purpose</p>
      <table class="corner10 porcelain">
        <thead>
          <tr><th>Type</th><th>Count</th></tr>
        </thead>
        <tbody id="purposeTable"></tbody>
      </table>
    </div>
  </section>
  <section class="col alignStart hidden">
    <div class="table-wrapper">
      <table>
        <thead>
          <tr><th>Document Type</th><th>Status</th><th>Count</th></tr>
        </thead>
        <tbody id="docStatusTable"></tbody>
      </table>
    </div>
  </section>
</section>

<script>
let chartInstances = {}; // Keep chart instances to destroy before redraw

// Create or update chart
function createChart(ctxId, labels, data, type='bar', label='') {
  if(chartInstances[ctxId]) chartInstances[ctxId].destroy();
  const ctx = document.getElementById(ctxId).getContext('2d');

  // Dynamic bar thickness
  let barThickness = 50;
  if(type === 'bar') {
    const chartWidth = document.getElementById(ctxId).offsetWidth;
    barThickness = 75; // max 150
  }

  // Colors
  let backgroundColors, borderColors;
  if(type === 'doughnut') {
    const palette = [
      '#00214d','#002b64','#004093','#005ac1','#3f80db','#6695e3','#8da9eb','#b4bef2','#0c1a3a','#102549'
    ];
    backgroundColors = labels.map((_, i) => palette[i % palette.length]);
    borderColors = labels.map(() => '#fff');
  } else if(type === 'line') {
    backgroundColors = 'white'; // fill under line
    borderColors = '#004093'; // line color
  } else { // bar
    backgroundColors = '#142c54';
    borderColors = 'white';
  }

  let borderWidths;
  if(type === 'doughnut') {
      borderWidths = '5';
  } else if ( type === 'line') {
      borderWidths = '1.8';
  } else {
      borderWidths =  '0.5';
  }

 chartInstances[ctxId] = new Chart(ctx, {
  type,
  data: {
    labels,
    
    datasets: [{
      label,
      data,
      backgroundColor: backgroundColors,
      borderColor: borderColors,
      borderWidth: borderWidths,
      borderRadius: type === 'bar' ? 16 : 10,
      barThickness: type === 'bar' ? barThickness : undefined,
      fill: type === 'line' ? true : undefined,
      tension: type === 'line' ? 0.2 : undefined, // smooth curve
      pointRadius: type === 'line' ? 2 : undefined,
      pointBackgroundColor: type === 'line' ? 'white' : undefined,
    }]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
      legend: { display: type === 'line' ? false : true , 
      labels: { 
          usePointStyle: type === 'doughnut' ? true : true,
          pointStyle: type === 'doughnut' ? 'circle' : 'rectRounded',
          color: 'black', font: { family: 'Poppins', weight: 'normal', size: '14' } } },
      tooltip: { enabled: true },
      // Add labels on top of bars
      datalabels: {
        display: type === 'doughnut',
        color: 'navy',
        anchor: 'center',
        align: 'center',                // distance from slice
        backgroundColor: 'white', // background color of label
        borderRadius: 6,            // rounded corners
        padding: 4, 
        font: { weight: 'normal', size: 12, family: 'Poppins' },
        formatter: function(value, context) {
          const dataArr = context.dataset.data;
          const total = dataArr.reduce((sum, val) => sum + val, 0);
          const percent = total ? ((value / total) * 100).toFixed(1) : 0;
          return percent === "0.0" ? "" : `${percent} %`;
        }
      }
    },
    scales: type === 'bar' || type === 'line' ? {
      y: {
        beginAtZero: true,
        ticks: { display: false },
        grid: { display: false }
      },
      x: {
        grid: { display: true },
        ticks: { font: { family: 'Poppins', size: '14', weight: 'normal' } }
      }
    } : {}
  },
});
}

// Populate tables and charts
function populateDashboard(analytics) {
  // Update top counts


let rangeText = "";
// Only show rangeText for certain filters
const filtersWithRange = ["thisWeek","lastWeek","specific","custom"];

if (filtersWithRange.includes(analytics.filterUsed)) {
    rangeText = `${analytics.rangeStart || "-"} to ${analytics.rangeEnd || "-"}`;
} else if (analytics.filterUsed === "overall") {
    rangeText = "All Time";
}

// Human-readable filter labels
const filterLabels = {
  today: "Today",
  yesterday: "Yesterday",
  thisWeek: "This Week",
  lastWeek: "Last Week",
  thisMonth: "This Month",
  lastMonth: "Last Month",
  thisYear: "This Year",
  lastYear: "Last Year",
  specific: "Specific Date",
  custom: "Custom Range",
  overall: "Overall"
};

// Get the label
const filterName = filterLabels[analytics.filterUsed] || analytics.filterUsed;

// Set the display text
document.getElementById("filterInfo").innerText = 
    filtersWithRange.includes(analytics.filterUsed) || analytics.filterUsed === "overall"
        ? `${rangeText}`
        : "";

document.getElementById("totalRequests").innerText = `${analytics.totalRequests || 0} Total Request`;
// document.getElementById("pending").innerText = analytics.pending || 0;

// Loop for status counts and percentages
const metrics = [
  { label: "Success", icon: "fa-check-square", key: "approved", percentKey: "approvedPercent" },
  { label: "On Process", icon: "fa-hourglass-half", key: "onProcess", percentKey: "onProcessPercent" },
  { label: "Declined", icon: "fa-xmark-square", key: "declined", percentKey: "declinedPercent" },
  { label: "On Hold", icon: "fa-clock", key: "onHold", percentKey: "onHoldPercent" }
];

const tpl = document.getElementById("metric");       // original HTML block
const container = document.getElementById("metricsContainer");

// Clear container if needed
container.innerHTML = "";

metrics.forEach(m => {
    let box = tpl.cloneNode(true); // copy the block

    box.querySelector(".label").innerText = m.label;
    box.querySelector(".icon").classList.add("fas", m.icon);

    // Show value and percentage together
    const value = analytics[m.key] || 0;
    const percent = analytics[m.percentKey] !== undefined ? analytics[m.percentKey] : 0;

    box.querySelector(".value").innerText = `${value}`;
    box.querySelector(".percentage").innerText = `${percent}`;

    container.appendChild(box);
});

tpl.remove();

function setText(id, value) {
    const el = document.getElementById(id);
    if (el) el.innerText = value;
}

setText("pending", analytics.pending || 0);
setText("myPending", analytics.myPending || 0);
setText("toVerifyUsers", analytics.toVerifyUsers || 0);

  document.getElementById("activeUserCount").innerText = `${analytics.activeUserCount || 0} Active`;
  // document.getElementById("toVerifyUsers").innerText = analytics.toVerifyUsers || 0;
  document.getElementById("avgApprovalTime").innerText = analytics.avgApprovalTime || 0;
  document.getElementById("avgApprovalTimeStat").innerText = analytics.avgApprovalTimeStat || 0;
  document.getElementById("avgReviewTime").innerText = analytics.avgReviewTime || 0;
  document.getElementById("avgReviewTimeStat").innerText = analytics.avgReviewTimeStat || 0;
  document.getElementById("avgAssessTime").innerText = analytics.avgAssessTime || 0;
  document.getElementById("avgAssessTimeStat").innerText = analytics.avgAssessTimeStat || 0;
  document.getElementById("totalRevenue").innerText = `₱ ${Number(analytics.totalRevenue || 0).toLocaleString()}`;
  document.getElementById("totalPaper").innerText = `${analytics.totalPaper || 0} Copies`;
  document.getElementById("totalRatings").innerText = `${analytics.totalRatings || 0} out ${analytics.activeUserCount || 0} Users`;

  const avgRating = analytics.avgRating || 0; // fallback to 0
  const maxStars = 5;

  let starsHTML = "";

  // Generate yellow stars for the rating
  for (let i = 1; i <= maxStars; i++) {
    if (i <= avgRating) {
      starsHTML += '<i class="fas fa-star yellow"></i> ';
    } else {
      starsHTML += '<i class="fas fa-star gray"></i> ';
    }
  }

  // Display as "Average Ratings: [stars]"
  document.getElementById("avgRating").innerHTML = `${starsHTML}`;


  const totalPaper = analytics.totalPaper || 0;
  document.getElementById("totalPaper").innerText = totalPaper === 0 ? "No Used" : `${totalPaper} Piece${totalPaper === 1 ? "" : "s"}`;


  const countU = analytics.currentUsersCount || 0;
  document.getElementById("currentUsersCount").innerText =`${countU} User${countU === 1 ? "" : "s"}`;
  const countW = analytics.previousUsersCount || 0;
  document.getElementById("previousUsersCount").innerText =`${countW} User${countW === 1 ? "" : "s"}`;

  document.getElementById("currentPeriodLabel").innerText = analytics.currentPeriodLabel;
  document.getElementById("previousPeriodLabel").innerText = analytics.previousPeriodLabel;


 const growthEl = document.getElementById("registrationGrowth");

// Fallback text
const growthText = analytics.registrationGrowth || "0";

// Reset classes
growthEl.classList.remove("bgRed100", "bgGreen100");

// Apply color coding with arrow icons
if (analytics.previousUsersCount > 0) {
    const diff = analytics.currentUsersCount - analytics.previousUsersCount;
    if (diff > 0) {
        growthEl.classList.add("bgGreen100");
        growthEl.classList.add("border0");
        growthEl.innerHTML = `${growthText} <i class="fas fa-arrow-up"></i>`;
    } else if (diff < 0) {
        growthEl.classList.add("bgRed100");
        growthEl.classList.add("border0");
        growthEl.innerHTML = `${growthText} <i class="fas fa-arrow-down"></i>`;
    } else {
        growthEl.innerText = growthText; // no change
    }
} else {
    if (analytics.currentUsersCount > 0) {
        growthEl.classList.add("bgGreen100");
        growthEl.classList.add("border0");
        growthEl.innerHTML = `${growthText} <i class="fas fa-arrow-up"></i>`;
    } else {
        growthEl.innerText = growthText; // "No New Users"
    }
}


// Clear tables
["topUsersTable","statusTable","docStatusTable","roleTable","courseTable","yearLevelTable","documentStats","purposeTable"].forEach(id => 
    document.getElementById(id).innerHTML = ""
);

// Helper to populate table
function populateTable(tableId, data, renderRow, emptyMsg = "No Data", colspan = 5) {
    const table = document.getElementById(tableId);
    if (!table) return;

    if (!data || data.length === 0) {
        table.innerHTML = `
          <tr>
            <td colspan="${colspan}" class="size14 gray str500 textCenter">${emptyMsg}</td>
          </tr>
        `;
    } else {
        data.forEach(item => {
            const tr = document.createElement("tr");
            tr.innerHTML = renderRow(item);
            table.appendChild(tr);
        });
    }
}

// TOP USERS TABLE (special layout)
populateTable("topUsersTable", analytics.topUsers, u => `
    <td class="width15">
      <img src="${u.userInfo.photo ? u.userInfo.photo : '/images/profile.png'}"
           alt="photo" class="marginRight10 h40 w40">
    </td>
    <td class="width85 inline" style="display: inline;">
      <div class="alignStart width0 col marginLeft10 width90">
        <p class="size16 str500">
          <a href="/stuViewDsb/${u.userInfo._id}" class="size16 navy str500 inline">
            ${u.userInfo.fName} ${u.userInfo.lName}
          </a>
          &bull;
          <span class="size16 str500">
            ${u.totalRequests} ${u.totalRequests === 1 ? "request" : "requests"}
          </span>
        </p>
        <p class="size12 textWrap">${u.userInfo.role} &bull; ${u.userInfo.course}</p>
      </div>
    </td>
`, "No Requestor", 2);

// OTHER TABLES
populateTable("yearLevelTable", analytics.yearLevelStats, d => `
    <td>${d._id}</td>
    <td class="textCenter">${d.count}</td>
    <td>${d.percentage.toFixed(1)}${d.percentage > 0 ? " %" : ""}</td>
`, "No Year Level Data", 3);

populateTable("statusTable", analytics.requestStatusStats, s => `
    <td>${s._id}</td>
    <td class="textCenter">${s.count}</td>
    <td>${s.percentage.toFixed(1)}${s.percentage > 0 ? " %" : ""}</td>
`, "No Status Data", 3);

populateTable("docStatusTable", analytics.docStatusStats, d => `
    <td>${d._id.type}</td>
    <td>${d._id.status}</td>
    <td>${d.count}</td>
`, "No Document Status Data", 3);

populateTable("roleTable", analytics.roleStats, d => `
    <td>${d._id}</td>
    <td>${d.count}</td>
`, "No Roles Found", 2);

populateTable("courseTable", analytics.courseStats, d => `
    <td>${d._id}</td>
    <td>${d.count}</td>
`, "No Courses Found", 2);

// Helper functions
function formatNumber(num) {
    return num.toLocaleString();
}

// function formatPaper(num) {
//     if (!num || num === 0) return "No Used";
//     return num === 1 ? "1 Copy" : `${num.toLocaleString()} Copies`;
// }

// Populate document stats table
populateTable("documentStats", analytics.documentStats, d => `
    <td>${d._id}</td>
    <td class="textCenter">${formatNumber(d.totalQty)}</td>
    <td class="textCenter">${formatNumber(d.totalRequests)}</td>
    <td class="textCenter">${d.totalPaper}</td>
    <td class="textRight" style="text-align: right !important;">₱ ${formatNumber(d.totalRevenue)}</td>
`, "No Document Statistics", 5);


populateTable("purposeTable", analytics.purposeStats, d => `
    <td>${d._id}</td>
    <td>${d.total}</td>
`, "No Purposes Found", 2);


  // Charts
  if (analytics.trend && analytics.trend.length) {
    // Filter out zero-count entries
    const filteredTrend = analytics.trend.filter(d => d.count > 0);
    const labels = filteredTrend.map(d => d.label);  // only months/days/hours with data
    const data = filteredTrend.map(d => d.count);
    createChart('trendChart', labels, data, 'line', 'Requests');
  } else {
    createChart('trendChart', [], [], 'line', 'Requests');
  }

    // Charts
  if (analytics.revenue && analytics.revenue.length) {
    // Filter out zero-revenue entries
    const filteredRevenue = analytics.revenue.filter(d => d.revenue > 0);
    const labels = filteredRevenue.map(d => d.label);  // only months/days/hours with revenue
    const data = filteredRevenue.map(d => d.revenue);  // use revenue field
    createChart('revenueChart', labels, data, 'bar', 'Revenue');
  } else {
    createChart('revenueChart', [], [], 'bar', 'Revenue');
  }



  if(analytics.roleStats && analytics.roleStats.length) 
    createChart('roleChart', analytics.roleStats.map(d=>d._id), analytics.roleStats.map(d=>d.count), 'bar', 'Request Per Student Type');
  if(analytics.courseStats && analytics.courseStats.length) 
    createChart('courseChart', analytics.courseStats.map(d=>d._id), analytics.courseStats.map(d=>d.count), 'bar', 'Requests by Course');
  if(analytics.yearLevelStats && analytics.yearLevelStats.length) 
    createChart('yearLevelChart', analytics.yearLevelStats.map(d=>d._id), analytics.yearLevelStats.map(d=>d.count), 'doughnut', 'Requests by Year Level');
  if(analytics.topDocuments && analytics.topDocuments.length) 
    createChart('documentChart', analytics.topDocuments.map(d=>d._id), analytics.topDocuments.map(d=>d.totalQty), 'bar', 'Top Documents');
  if(analytics.topPurpose && analytics.topPurpose.length) 
    createChart('topPurpose', analytics.topPurpose.map(d=>d._id), analytics.topPurpose.map(d=>d.total), 'bar', 'Top Document Purposes');
  if(analytics.requestStatusStats && analytics.requestStatusStats.length) 
    createChart('requestStatusStats', analytics.requestStatusStats.map(d=>d._id), analytics.requestStatusStats.map(d=>d.count), 'doughnut', 'Status Breakdown');
}

// Fetch analytics from API
async function fetchAnalytics(range="thisYear") {
    let url = `/api/analytics?range=${range}`;

    if(range === "specific") {
        const date = document.getElementById("specificDate").value;
        if(date) url += `&date=${date}`;
    } else if(range === "custom") {
        const start = document.getElementById("customStart").value;
        const end = document.getElementById("customEnd").value;
        if(start && end) url += `&start=${start}&end=${end}`;
    }

    try {
        const res = await fetch(url);
        const data = await res.json();
        populateDashboard(data);
    } catch(err) {
        console.error("Error fetching analytics:", err);
    }
}


// Filter change event
document.getElementById("filterSelect").addEventListener("change", e => {
  fetchAnalytics(e.target.value);
});

// ----------------------------
// Date input listeners (add these at the bottom)
// ----------------------------
specificDate.addEventListener("change", () => {
    fetchAnalytics("specific");
});

customStart.addEventListener("change", () => {
    const end = customEnd.value;
    if(end) fetchAnalytics("custom");
});

customEnd.addEventListener("change", () => {
    const start = customStart.value;
    if(start) fetchAnalytics("custom");
});

// Load default analytics
fetchAnalytics(document.getElementById("filterSelect").value);
</script>