<% layout('layout') %>
<style>
    .grid2col {
  display: grid;
  grid-template-columns: 1fr 1fr;
  column-gap: 5%;
}
.borderLeft {
    border-left: 1px solid gray;
}
</style>

<section class="justifyBetween">
    <p class="size34 str400">Settings: Contact & Documents</p>
</section>
<hr>


<section class="row relative alignStart justifyBetween relative gap20">
    <form action="/updateSeed" method="POST" class="col padding20 alignStart width35" data-form="seed">
        <section class="col justifyBetween alignStart padding0">
            <p class="rem24 str400">Contacts</p>
            <hr>
            <% if (seedSuccess) { %>
            <p class="bgBlue100 marginTop10"><i class="fas fa-check-circle"></i> <%= seedSuccess %></p>
            <% } %>
            <% if (seedError) { %>
            <p class="bgRed100 marginTop10"><i class="fas fa-exclamation-circle"></i> <%= seedError %></p>
            <% } %>
        </section>
        <br>
        
        <div class="field">
            <label for="email">Email</label>
            <input type="email" name="email" id="email" value="<%= seedUser ? seedUser.email : '' %>" required>
        </div>
        <br>

        <div class="field">
            <label for="phone">Phone</label>
            <input type="text" name="phone" id="phone" value="<%= seedUser ? seedUser.phone : '' %>" required>
        </div>
        <br>

        <div class="field">
            <button type="submit" class="nav pnav width100">Update</button>
        </div>
    </form>

    <div class="hidden width65 bgWhite corner15 padding20 relative h300 col justifyStart alignStart">
        <img src="<%= seedUser.photo ? seedUser.photo : '/images/annPhoto2.jpg' %>" onerror="this.onerror=null; this.src='/images/annPhoto2.jpg';" alt="logo" class="hidden absolute right30 bottom10 h120 w120 scale3 opacity05">
        <p class="rem24 str400">Forms</p>
        <hr>
        <div class="section gap30 corner15 padding20">
            <form action="" class="gap10 glass width40">
                <div class="field colorPrimary">
                    <label for="">Dismissal Form</label>
                    <input type="file" name="" id="">
                </div>
                <div class="field">
                    <button type="submit" class="nav width100">Upload</button>
                </div>
            </form>
            <form action="" class="gap10 glass width40">
                <div class="field colorPrimary">
                    <label for="">Dismissal Form</label>
                    <input type="file" name="" id="">
                </div>
                <div class="field">
                    <button type="submit" class="nav width100">Upload</button>
                </div>
            </form>
        </div>
    </div>
</section>

<section class="col relative">
    <form action="/update-documents" method="POST" class="col paddingInline40 paddingTop10" data-form="documents">
        <section class="justifyBetween padding0">
            <p class="rem24 str400">Documents Management</p>
            <% if (docSuccess) { %>
            <p class="bgBlue100"><i class="fas fa-check-circle"></i> <%= docSuccess %></p>
            <% } %>
            <% if (docError) { %>
            <p class="bgRed100"><i class="fas fa-exclamation-circle"></i> <%= docError %></p>
            <% } %>
        </section>
        <hr><br>
        <div class="grid2col gap5 padding0 marginBottom10">
            <section class="colorPrimary gap10 paddingTop10 bgYellow corner10">
                <p class="rem12 str500 textLeft width60"><i class="fas fa-file-lines"></i> Type</p>
                <p class="rem12 str500 textCenter width20 borderLeft"><i class="fas fa-coins"></i> Price</p>
                <p class="rem12 str500 textCenter width20 borderLeft"><i class="fas fa-calendar"></i> Days</p>
            </section>
            <section class="colorPrimary gap10 paddingTop10 bgYellow corner10">
                <p class="rem12 str500 textLeft width60"><i class="fas fa-file-lines"></i> Type</p>
                <p class="rem12 str500 textCenter width20 borderLeft"><i class="fas fa-coins"></i> Price</p>
                <p class="rem12 str500 textCenter width20 borderLeft"><i class="fas fa-calendar"></i> Days</p>
            </section>
        </div>
        <div class="grid2col gap5">
            <% documents.forEach((doc, index) => { %>
            <section class="bgSoft gap10 corner12 padding5">
                <input type="hidden" name="docs[<%= index %>][id]" value="<%= doc._id %>">

                <div class="justifyStart width60">
                    <input type="text" name="docs[<%= index %>][type]" value="<%= doc.type %>">
                </div>
                <div class="justifyStart width20">
                    <input type="text" name="docs[<%= index %>][amount]" value="<%= doc.amount %>" class="textCenter">
                </div>
                <div class="justifyStart width20">
                    <input type="text" name="docs[<%= index %>][days]" value="<%= doc.days %>" class="textCenter">
                </div>
            </section>
            <% }) %>
        </div>
        <br>
        <section class="justifyEnd padding0">
            <button type="submit" class="nav pnav width20">Update</button>
        </section>
    </form>
</section>


<br>

<div class="fixed top0 right0 bgModal7 hidden" id="confirmCard">
    <section class="width0 corner20 bgWhite col padding30 width30">
        <%- include('icons/warning') %>
        <p class="rem28 str500">WARNING!</p>
        
        <p class="bgYellow100 size14 width100">You are about to change sensitive and essential information on the system. Are you sure you want to proceed? Action can't be undone! </p>
        <br>
        <label for="" class="size14">For Security: Enter your password!</label>
        <input type="password" name="confirmPassword" id="confirmPassword" required>
        <p class="bgRed100 size14 marginBlock10 hidden" id="modalError"><i class="fas fa-exclamation-circle"></i> Incorrect password!</p>
        <br>
        <section class="gap10 padding0">
            <a href="javascript:void(0)" id="cancelBtn" class="nav width100">Cancel</a>
            <a href="javascript:void(0)" id="proceedBtn" class="nav pnav width100">Update</a>   
        </section>
    </section>
</div>


<script>
  const confirmCard = document.getElementById('confirmCard');
  const cancelBtn = document.getElementById('cancelBtn');
  const proceedBtn = document.getElementById('proceedBtn');
  const modalError = document.getElementById('modalError');
  const passwordInput = document.getElementById('confirmPassword');

  let activeForm = null;

  document.querySelectorAll('form[data-form]').forEach(form => {
    form.addEventListener('submit', function(e) {
      e.preventDefault();
      activeForm = form;
      passwordInput.value = '';
      modalError.classList.add('hidden');
      confirmCard.classList.remove('hidden');
    });
  });

  cancelBtn.addEventListener('click', function() {
    confirmCard.classList.add('hidden');
    activeForm = null;
  });

  proceedBtn.addEventListener('click', async function() {
    const password = passwordInput.value.trim();
    if (!password) {
      modalError.textContent = 'Password is required!';
      modalError.classList.remove('hidden');
      return;
    }

    try {
      // AJAX call to validate password without submitting the form
      const response = await fetch('/validate-password', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ password })
      });
      const result = await response.json();

    if (!result.valid) {
    modalError.classList.remove('hidden'); // show the error
    return; // stop submission
    } else {
    modalError.classList.add('hidden'); // hide error if previously shown
    }

      // Password correct â†’ attach to form and submit
      let hidden = activeForm.querySelector('input[name="confirmPasswordHidden"]');
      if (!hidden) {
        hidden = document.createElement('input');
        hidden.type = 'hidden';
        hidden.name = 'confirmPasswordHidden';
        activeForm.appendChild(hidden);
      }
      hidden.value = password;

      confirmCard.classList.add('hidden');
      activeForm.submit();
      activeForm = null;

    } catch (err) {
      console.error(err);
      modalError.textContent = 'Error verifying password!';
      modalError.classList.remove('hidden');
    }
  });
</script>
