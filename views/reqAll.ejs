<% layout('scheme') %>

<style>
        .rqMainCard {
            max-height: 82%;
            display: block;
        }
        .card3 {
            display: flex;
        }
        .card1 {
            display: none;
        }
    @media (max-width: 900px) {
        .rqMainCard {
            max-height: 400px;
            display: block;
        }
        .card1 {
            height: auto;
            display: flex;
        }
        .card3 {
            display: none !important;
        }
    }
</style>

    
    <%
        function formatCustomDate(dateString) {
        const d = new Date(dateString);
        const now = new Date();

        const oneDay = 24 * 60 * 60 * 1000;
        const diffDays = Math.floor((now - d) / oneDay);

        // Today
        if (diffDays === 0) return "Today";

        // Yesterday
        if (diffDays === 1) return "Yesterday";

        // Format month + day
        const options = { month: "short", day: "numeric" };
        let formatted = d.toLocaleDateString("en-US", options);

        // Add year if not current year
        if (d.getFullYear() !== now.getFullYear()) {
            formatted += ", " + d.getFullYear();
        }

        return formatted;
        }
    %>
    <br>
<section class="col padding0 corner15 card1 width30">
    <section class="justifyBetween gap10 corner20 alignCenter marginBottom10 liquidX">
        <a href="/hom" class="nav liquid"><i class="fas fa-chevron-left"></i>Go Back</a>
        <a href="/reqPre" class="nav liquid glowImg2"><i class="fas fa-plus"></i> Request</a>
    </section>
</section>
<section class="col padding0 corner15 card3 width0 absolute left60 top80">
    <section class="justifyBetween gap10 corner20 alignCenter marginBottom10 liquidX">
        <a href="/hom" class="nav liquid"><i class="fas fa-chevron-left"></i>Go Back</a>
        <a href="/reqPre" class="nav liquid glowImg2"><i class="fas fa-plus"></i> Request</a>
    </section>
</section>
<section class="col padding0 bgSoft corner15 padding15 block card2 width60">

    <div class="searchBar colorPrimary marginBottom10" style="width: 100% !important;">
        <i class="fas fa-search"></i>
        <input type="search" id="univ" class="" placeholder="Search here">
    </div>

<% if (requests && requests.length > 0) { %>
        <section class="bgWhite col gap5 corner15 rqMainCard overflow-y1 block">
            <% requests.forEach(req => { %>
                <div class="col gap5 padding10" id="noRecords" style="display: none;">
                    <%- include('icons/notFound') %>
                    <p class="size14 str500">No Records Found</p>
                </div>
                <a href="/reqView2/<%= req._id %>" class="width100 col alignStart padding10 shadow1 corner10 relative" id="reqCards1">
                    <% if (req.items && req.items.length > 0) { %>
                        <% req.items.forEach(item => { %>
                        <p class="size16 str500"><%= item.qty %> <%= item.type %></p>
                        <% }) %>
                    <% } else { %>
                        <p class="size12 str500">No items found for this request.</p>
                    <% } %>
                    <p class="size12 str500">TR# <%= req.tr %></p>
                    <% if ( req.holdAt ) { %>
                        <div class="size12 str400 padding0 cornerRem1 str500 width0 statIcon bgRed100"  style="background-color: transparent;">
                            On Hold
                        </div>
                    <% } else if ( req.declineAt ) { %>
                        <div class="size12 str400 padding0 cornerRem1 str500 width0 statIcon bgRed100 border0"  style="background-color: transparent;">
                            Declined
                        </div>
                    <% } else { %>
                        <div class="size12 str400 padding0 str500 width0 statIcon
                        <% if ( req.status === "Pending" ) { %>
                            bgBlue100
                        <% } else if ( req.status === "Reviewed" ) { %>
                            bgViolet100
                        <% } else if ( req.status === "Assessed" ) { %>
                            bgYellow100
                        <% } else if ( req.status === "Verified" ) { %>
                            bgGreen100
                        <% } else if ( req.status === "For Release" ) { %>
                            bgGreen100
                        <% } else if ( req.status === "Claimed" ) { %>
                            bgGray100
                        <% } else { %>
                            bgBlue100
                        <% } %> border0 corner0
                        " style="background-color: transparent;">
                            <i class="fas fa-hourglass inline rem1 w15 h15 hidden"></i>
                            <%= req.status === "Assessed" ? "For Payment" : req.status === "Reviewed" ? "For Assessment" : req.status || "" %>
                        </div>
                    <% } %>
                    <p class="size12 darkGray absolute right10 top10"><%= formatCustomDate(req.createdAt) %></p>
                </a>
            <% }) %>
        </section>
        
        <div class="sub height0 row flex marginTop10 porcelain colorPrimary corner10 padding10">
            <div class="ctrl height0 gap10 justifyBetween">
                <div class="height0 gap5 width0" id="subGrand">
                    <div class="size14 gap5">
                    <span id="totalRecords" class="totalRecords"></span>
                        | Display: &nbsp;
                    </div>
                    <div class="selectBar" style="width: 120px;"> 
                        <select id="rowsPerPage" onchange="updateRowsPerPage()">
                            <option value="5">5</option>
                            <option value="10">10</option>
                            <option value="50">50</option>
                            <option value="100">100</option>
                            <option value="1000000000000">All</option>
                        </select>
                    </div>
                </div>
                <div class="pagination colorPrimary width0" id="pagination"></div>
            </div>
        </div>

    <% } else { %>
        <div class="col gap5 marginBlock15 padding10">
            <%- include('icons/notFound') %>
            <p class="size14 str500">You have no requests yet!</p>
        </div>
    <% } %>

</section>


    
<script>
document.addEventListener("DOMContentLoaded", function() {
    const cardsContainer = document.querySelector(".rqMainCard");
    const cards = Array.from(cardsContainer.querySelectorAll("#reqCards1"));
    const paginationContainer = document.getElementById("pagination");
    const rowsPerPageSelect = document.getElementById("rowsPerPage");
    const totalRecordsLabel = document.getElementById("totalRecords");
    const searchInput = document.getElementById("univ");
    const noRecordsMessage = document.getElementById("noRecords");
    const subDiv = document.querySelector(".sub");

    let currentPage = 1;
    let rowsPerPage = parseInt(rowsPerPageSelect.value);
    let filteredCards = [...cards];

    function renderCards() {
        const start = (currentPage - 1) * rowsPerPage;
        const end = start + rowsPerPage;

        // Hide all cards first
        cards.forEach(card => card.style.display = "none");

        if (filteredCards.length === 0) {
            noRecordsMessage.style.display = "flex"; // show "No Records"
            paginationContainer.style.display = "none"; // hide pagination
            return;
        } else {
            noRecordsMessage.style.display = "none";
        }

        // Show only the cards for current page (for pagination)
        filteredCards.slice(start, end).forEach(card => card.style.display = "flex");

        // Update total records
        totalRecordsLabel.innerText = `Showing ${filteredCards.length} Records`;

        // Show/hide pagination only when search is empty
        if (searchInput.value.trim() === "") {
            paginationContainer.style.display = filteredCards.length <= rowsPerPage ? "none" : "flex";
        } else {
            paginationContainer.style.display = "none"; // hide pagination during search
        }

        renderPagination();
    }

    function renderPagination() {
        paginationContainer.innerHTML = "";
        if (searchInput.value.trim()) return;

        const totalPages = Math.ceil(filteredCards.length / rowsPerPage);
        if (totalPages <= 1) return;

        const createPageButton = (text, page = null, isEllipsis = false) => {
            const btn = document.createElement("button");
            btn.innerHTML = text;
            btn.disabled = isEllipsis || (page !== null && (page < 1 || page > totalPages));
            if (page !== null && !isEllipsis) {
                btn.className = page === currentPage ? "active" : "";
                btn.onclick = () => {
                    currentPage = page;
                    renderCards();
                };
            }
            return btn;
        };

        // Previous button
        paginationContainer.appendChild(createPageButton("« Previous", currentPage - 1));

        if (totalPages <= 5) {
            for (let i = 1; i <= totalPages; i++) {
                paginationContainer.appendChild(createPageButton(i, i));
            }
        } else {
            const startPages = [1, 2, 3];
            const endPages = [totalPages - 2, totalPages - 1, totalPages];
            const middlePages = [currentPage - 1, currentPage, currentPage + 1];

            // First pages
            startPages.forEach(p => {
                if (p <= totalPages) paginationContainer.appendChild(createPageButton(p, p));
            });

            // Ellipsis after start pages
            if (currentPage > 4) paginationContainer.appendChild(createPageButton("...", null, true));

            // Middle pages
            middlePages.forEach(p => {
                if (p > 3 && p < totalPages - 2) paginationContainer.appendChild(createPageButton(p, p));
            });

            // Ellipsis before end pages
            if (currentPage < totalPages - 3) paginationContainer.appendChild(createPageButton("...", null, true));

            // Last pages
            endPages.forEach(p => {
                if (p > 3) paginationContainer.appendChild(createPageButton(p, p));
            });
        }

        // Next button
        paginationContainer.appendChild(createPageButton("Next »", currentPage + 1));
    }

    function updateRowsPerPage() {
        rowsPerPage = parseInt(rowsPerPageSelect.value);
        currentPage = 1;
        renderCards();
    }

    function searchCards() {
        const query = searchInput.value.toLowerCase().trim();
        filteredCards = cards.filter(card =>
            card.textContent.toLowerCase().includes(query)
        );
        currentPage = 1;
        renderCards();
    }

    rowsPerPageSelect.addEventListener("change", updateRowsPerPage);
    searchInput.addEventListener("input", searchCards);

    renderCards();
});
</script>
